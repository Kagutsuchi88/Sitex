{"file_contents":{"main.py":{"content":"# main.py\nfrom app_factory import create_app\n\napp = create_app()  # ‚Üê ¬°ESTO ES LO QUE FALTA!\n\nif __name__ == '__main__':\n    app.run(debug=True, host='0.0.0.0', port=5000)\n\n# from flask import Flask, jsonify\n# from flask_cors import CORS\n# import mysql.connector\n\n# app = Flask(__name__)\n# CORS(app)\n\n# def conectar_bd():\n#     return mysql.connector.connect(\n#         host='localhost',\n#         user='root',\n#         password='',\n#         database='sitex_prueba'\n#     )\n\n# @app.route('/api/tanques', methods=['GET'])\n# def obtener_tanques():\n#     conexion = conectar_bd()\n#     cursor = conexion.cursor(dictionary=True)\n#     cursor.execute(\"SELECT * FROM tanques\")\n#     resultados = cursor.fetchall()\n#     cursor.close()\n#     conexion.close()\n#     return jsonify(resultados)\n\n# if __name__ == '__main__':\n#     app.run(debug=True, host='0.0.0.0', port=5000)","path":null,"size_bytes":872,"size_tokens":null},"replit.md":{"content":"# Hayuelos - Sistema de Gesti√≥n de Estaci√≥n de Servicios\n\n## Overview\nSistema web para gesti√≥n de estaci√≥n de combustible Hayuelos. Incluye autenticaci√≥n de usuarios, gesti√≥n de tanques, mediciones y reportes.\n\n## Tech Stack\n- **Backend**: Python 3.11, Flask 3.0.0\n- **Database**: PostgreSQL (Replit)\n- **Frontend**: Bootstrap 5.3, Jinja2 templates\n- **Email**: Gmail SMTP con Flask-Mail\n\n## Project Structure\n```\n‚îú‚îÄ‚îÄ main.py              # Entry point\n‚îú‚îÄ‚îÄ app_factory.py       # Flask app factory\n‚îú‚îÄ‚îÄ routes.py            # All routes and blueprints\n‚îú‚îÄ‚îÄ models.py            # SQLAlchemy models\n‚îú‚îÄ‚îÄ forms.py             # WTForms\n‚îú‚îÄ‚îÄ extensions.py        # Flask extensions\n‚îú‚îÄ‚îÄ templates/           # Jinja2 templates\n‚îÇ   ‚îú‚îÄ‚îÄ auth/           # Login, register, password reset\n‚îÇ   ‚îú‚îÄ‚îÄ dashboard/      # Main dashboard views\n‚îÇ   ‚îú‚îÄ‚îÄ admin/          # Admin views\n‚îÇ   ‚îî‚îÄ‚îÄ medicion/       # Measurement views\n‚îî‚îÄ‚îÄ static/             # CSS, images, uploads\n```\n\n## Environment Variables\n- `DATABASE_URL`: PostgreSQL connection string (auto-configured)\n- `MAIL_USERNAME`: Gmail address for sending emails\n- `MAIL_PASSWORD`: Gmail app password (16 characters)\n- `SECRET_KEY`: Flask secret key\n\n## Email Configuration\nThe app uses Gmail SMTP for sending confirmation and password reset emails:\n- Server: smtp.gmail.com\n- Port: 587\n- TLS: Enabled\n\n**Note**: Gmail requires an \"App Password\" for third-party apps. Generate one at https://myaccount.google.com/apppasswords\n\n## Recent Changes\n- 2025-12-13: Fixed vertical scrolling on login/register pages\n- 2025-12-13: Configured PostgreSQL database\n- 2025-12-13: Added Gmail SMTP credentials for email functionality\n\n## User Preferences\n- Language: Spanish (es)\n- Target deployment: Vercel (originally), now Replit\n","path":null,"size_bytes":1842,"size_tokens":null},"forms.py":{"content":"# forms.py - ACTUALIZADO CON MEJORAS\nfrom flask_wtf import FlaskForm\nfrom flask_wtf.file import FileField, FileAllowed\nfrom wtforms import StringField, PasswordField, BooleanField, SelectField, TextAreaField, DecimalField, DateField, IntegerField, SubmitField, FileField as WTFileField\nfrom wtforms.validators import DataRequired, Email, Length, Optional, NumberRange, EqualTo, ValidationError\nfrom datetime import date\n\nclass LoginForm(FlaskForm):\n    username = StringField(\"Usuario o Documento *\", validators=[DataRequired(message=\"Campo obligatorio\")], \n                         render_kw={\"placeholder\": \"Ingrese su usuario o documento\"})\n    password = PasswordField(\"Contrase√±a *\", validators=[DataRequired(message=\"Campo obligatorio\")],\n                           render_kw={\"placeholder\": \"Ingrese su contrase√±a\"})\n    remember_me = BooleanField(\"Recu√©rdame\")\n    submit = SubmitField(\"Iniciar Sesi√≥n\")\n\nclass RegisterForm(FlaskForm):\n    nombre_empleado = StringField(\"Nombre *\", validators=[DataRequired(message=\"Campo obligatorio\"), Length(max=30)],\n                                render_kw={\"placeholder\": \"Ingrese su nombre\"})\n    apellido_empleado = StringField(\"Apellido *\", validators=[DataRequired(message=\"Campo obligatorio\"), Length(max=30)],\n                                   render_kw={\"placeholder\": \"Ingrese su apellido\"})\n    numero_documento = StringField(\"N√∫mero de Documento *\", validators=[DataRequired(message=\"Campo obligatorio\"), Length(max=20)],\n                                  render_kw={\"placeholder\": \"N√∫mero de documento\"})\n    tipo_documento = SelectField(\"Tipo Documento *\", choices=[\n        (\"CC\", \"C√©dula\"), (\"CE\", \"C√©dula Extranjer√≠a\"), (\"TI\", \"Tarjeta Identidad\")\n    ], validators=[DataRequired(message=\"Campo obligatorio\")])\n    email = StringField(\"Email *\", validators=[DataRequired(message=\"Campo obligatorio\"), Email(message=\"Email inv√°lido\"), Length(max=45)],\n                      render_kw={\"placeholder\": \"ejemplo@correo.com\"})\n    telefono = StringField(\"Tel√©fono\", validators=[Optional(), Length(max=15)],\n                         render_kw={\"placeholder\": \"Tel√©fono\"})\n    direccion = StringField(\"Direcci√≥n\", validators=[Optional(), Length(max=45)],\n                          render_kw={\"placeholder\": \"Direcci√≥n\"})\n    usuario = StringField(\"Usuario *\", validators=[DataRequired(message=\"Campo obligatorio\"), Length(max=15)],\n                        render_kw={\"placeholder\": \"Nombre de usuario\"})\n    cargo_establecido = SelectField(\n        \"Cargo *\",\n        choices=[(\"islero\", \"Islero\"), (\"encargado\", \"Encargado\"), (\"admin\", \"Administrador\")],\n        validators=[DataRequired(message=\"Campo obligatorio\")]\n    )\n    aceptar_terminos = BooleanField(\"Acepto los t√©rminos y condiciones y la pol√≠tica de privacidad *\", \n                                   validators=[DataRequired(message=\"Debe aceptar los t√©rminos\")])\n    submit = SubmitField(\"Registrarse\")\n\nclass MedicionForm(FlaskForm):\n    \"\"\"Formulario de medici√≥n - SOLO RUTINARIO\"\"\"\n    medida_combustible = StringField('Medida (cm) *', \n        validators=[DataRequired(message=\"Campo obligatorio\")],\n        render_kw={\"placeholder\": \"Medida en cm\"})\n    \n    galones = DecimalField('Galones', \n        validators=[Optional()],\n        places=2,\n        render_kw={\"readonly\": True, \"id\": \"galones\"})\n    \n    tanque = SelectField('Tanque *', \n        coerce=int, \n        validators=[DataRequired(message=\"Campo obligatorio\")])\n    \n    # SOLO RUTINARIO - sin opciones de cargue/descargue\n    tipo_medida = SelectField('Tipo de Medici√≥n *',\n        choices=[('rutinario', 'Rutinario')],  # Solo rutinario\n        default='rutinario',\n        validators=[DataRequired(message=\"Campo obligatorio\")])\n    \n    novedad = TextAreaField('Novedad', \n        validators=[Optional(), Length(max=255)],\n        render_kw={\"placeholder\": \"Observaciones adicionales\", \"rows\": 3})\n    \n    imagen = FileField('Foto de Factura', \n        validators=[FileAllowed(['jpg', 'jpeg', 'png', 'pdf'], 'Solo im√°genes o PDF')])\n    \n    submit = SubmitField(\"Guardar Medici√≥n\")\n\n\nclass DescargueForm(FlaskForm):\n    \"\"\"Formulario de descargue con selectores de tanque\"\"\"\n    tanque = SelectField('Tanque *',  # Cambiado a SelectField\n        coerce=int,\n        validators=[DataRequired(message=\"Campo obligatorio\")])\n    \n    medida_inicial_cm = DecimalField('Medida Inicial (cm) *', \n        validators=[DataRequired(message=\"Campo obligatorio\")], \n        places=2)\n    \n    medida_inicial_gl = DecimalField('Medida Inicial (gl)', \n        validators=[Optional()], \n        places=2)\n    \n    descargue_cm = DecimalField('Descargue (cm) *', \n        validators=[DataRequired(message=\"Campo obligatorio\")], \n        places=2)\n    \n    descargue_gl = DecimalField('Descargue (gl)', \n        validators=[Optional()], \n        places=2)\n    \n    medida_final_cm = DecimalField('Medida Final (cm)', \n        validators=[Optional()], \n        places=2)\n    \n    medida_final_gl = DecimalField('Medida Final (gl)', \n        validators=[Optional()], \n        places=2)\n    \n    diferencia = DecimalField('Diferencia', \n        validators=[Optional()], \n        places=2)\n    \n    # Seguridad del conductor - checkboxes en el template\n    botas = SelectField('Botas *', \n        choices=[('si', 'S√≠'), ('no', 'No')], \n        default='si')\n    \n    gafas = SelectField('Gafas *', \n        choices=[('si', 'S√≠'), ('no', 'No')], \n        default='si')\n    \n    tapaoidos = SelectField('Tapao√≠dos *', \n        choices=[('si', 'S√≠'), ('no', 'No')], \n        default='si')\n    \n    guantes = SelectField('Guantes *', \n        choices=[('si', 'S√≠'), ('no', 'No')], \n        default='si')\n    \n    # Seguridad del veh√≠culo\n    kit_derrames = SelectField('Kit Derrames *', \n        choices=[('si', 'S√≠'), ('no', 'No')], \n        default='si')\n    \n    extintores = SelectField('Extintores *', \n        choices=[('si', 'S√≠'), ('no', 'No')], \n        default='si')\n    \n    conos = SelectField('Conos *', \n        choices=[('si', 'S√≠'), ('no', 'No')], \n        default='si')\n    \n    boquillas = SelectField('Boquillas *', \n        choices=[('si', 'S√≠'), ('no', 'No')], \n        default='si')\n    \n    # Calidad del combustible con botones ON/OFF\n    brillante = SelectField('Brillante *', \n        choices=[('si', 'S√≠'), ('no', 'No')], \n        default='si')\n    \n    traslucido = SelectField('Trasl√∫cido *', \n        choices=[('si', 'S√≠'), ('no', 'No')], \n        default='si')\n    \n    claro = SelectField('Claro *', \n        choices=[('si', 'S√≠'), ('no', 'No')], \n        default='si')\n    \n    solidos = SelectField('S√≥lidos *', \n        choices=[('si', 'S√≠'), ('no', 'No')], \n        default='no')\n    \n    separacion = StringField('Separaci√≥n', \n        validators=[Optional(), Length(max=50)])\n    \n    observaciones1 = TextAreaField('Observaciones 1', \n        validators=[Optional(), Length(max=255)])\n    \n    observaciones2 = TextAreaField('Observaciones 2', \n        validators=[Optional(), Length(max=255)])\n    \n    fecha = DateField('Fecha', \n        validators=[Optional()], \n        default=date.today)\n    \n    imagen = FileField('Foto de Factura', \n        validators=[FileAllowed(['jpg', 'jpeg', 'png', 'pdf'], 'Solo im√°genes o PDF')])\n    \n    submit = SubmitField(\"Registrar Descargue\")\n\n\nclass CargueEmergenciaForm(FlaskForm):\n    \"\"\"NUEVO: Formulario para cargue de emergencia\"\"\"\n    tanque = SelectField('Tanque *',\n        coerce=int,\n        validators=[DataRequired(message=\"Campo obligatorio\")])\n    \n    medida_anterior = StringField('Medida Anterior (cm) *',\n        validators=[DataRequired(message=\"Campo obligatorio\")],\n        render_kw={\"placeholder\": \"Medida antes del cargue\"})\n    \n    medida_posterior = StringField('Medida Posterior (cm) *',\n        validators=[DataRequired(message=\"Campo obligatorio\")],\n        render_kw={\"placeholder\": \"Medida despu√©s del cargue\"})\n    \n    formato_entrega = SelectField('Formato de Entrega *',\n        choices=[\n            ('pipa', 'Pipa'),\n            ('camion', 'Cami√≥n'),\n            ('otro', 'Otro')\n        ],\n        validators=[DataRequired(message=\"Campo obligatorio\")])\n    \n    galones_totales = DecimalField('Galones Totales *',\n        validators=[DataRequired(message=\"Campo obligatorio\")],\n        places=2,\n        render_kw={\"placeholder\": \"Total de galones cargados\"})\n    \n    observaciones = TextAreaField('Observaciones',\n        validators=[Optional(), Length(max=255)],\n        render_kw={\"rows\": 3, \"placeholder\": \"Detalles del cargue de emergencia\"})\n    \n    imagen = FileField('Foto del Remito/Factura',\n        validators=[FileAllowed(['jpg', 'jpeg', 'png', 'pdf'], 'Solo im√°genes o PDF')])\n    \n    submit = SubmitField(\"Registrar Cargue de Emergencia\")\n\nclass ChangePasswordForm(FlaskForm):\n    current_password = PasswordField('Contrase√±a Actual *', validators=[DataRequired(message=\"Campo obligatorio\")],\n                                   render_kw={\"placeholder\": \"Contrase√±a actual\"})\n    new_password = PasswordField('Nueva Contrase√±a *', validators=[DataRequired(message=\"Campo obligatorio\"), Length(min=6, message=\"M√≠nimo 6 caracteres\")],\n                               render_kw={\"placeholder\": \"Nueva contrase√±a (m√≠n. 6 caracteres)\"})\n    confirm_password = PasswordField('Confirmar Contrase√±a *', \n                                   validators=[DataRequired(message=\"Campo obligatorio\"), EqualTo('new_password', message='Las contrase√±as deben coincidir')],\n                                   render_kw={\"placeholder\": \"Confirmar nueva contrase√±a\"})\n    submit = SubmitField('Cambiar Contrase√±a')\n\nclass ResetPasswordForm(FlaskForm):\n    submit = SubmitField('Resetear')\n\nclass RequestPasswordResetForm(FlaskForm):\n    email = StringField('Email *', validators=[DataRequired(message=\"Campo obligatorio\"), Email(message=\"Email inv√°lido\")],\n                      render_kw={\"placeholder\": \"ejemplo@correo.com\"})\n    submit = SubmitField('Enviar Enlace de Recuperaci√≥n')\n\nclass PasswordResetForm(FlaskForm):\n    password = PasswordField('Nueva Contrase√±a *', validators=[DataRequired(message=\"Campo obligatorio\"), Length(min=6, message=\"M√≠nimo 6 caracteres\")],\n                           render_kw={\"placeholder\": \"Nueva contrase√±a (m√≠n. 6 caracteres)\"})\n    confirm_password = PasswordField('Confirmar Contrase√±a *',\n                                   validators=[DataRequired(message=\"Campo obligatorio\"), EqualTo('password', message='Las contrase√±as deben coincidir')],\n                                   render_kw={\"placeholder\": \"Confirmar nueva contrase√±a\"})\n    submit = SubmitField('Restablecer Contrase√±a')\n\nclass TanqueForm(FlaskForm):\n    tipo_combustible = StringField('Tipo de Combustible *', validators=[DataRequired(message=\"Campo obligatorio\"), Length(max=45)],\n                                  render_kw={\"placeholder\": \"Diesel, ACPM, Extra, etc.\"})\n    capacidad = IntegerField('Capacidad (galones) *', validators=[DataRequired(message=\"Campo obligatorio\"), NumberRange(min=1, message=\"Debe ser mayor a 0\")],\n                           render_kw={\"placeholder\": \"Capacidad en galones\"})\n    activo = BooleanField('Tanque Activo', default=True)\n    submit = SubmitField('Guardar Tanque')\n\nclass CargaMasivaForm(FlaskForm):\n    archivo = FileField('Archivo CSV/Excel *', validators=[\n        DataRequired(message=\"Debe seleccionar un archivo\"),\n        FileAllowed(['csv', 'xlsx', 'xls'], 'Solo archivos CSV o Excel')\n    ])\n    tipo_carga = SelectField('Tipo de Carga *', choices=[\n        ('empleados', 'Empleados'),\n        ('tanques', 'Tanques'),\n        ('mediciones', 'Mediciones')\n    ], validators=[DataRequired(message=\"Campo obligatorio\")])\n    submit = SubmitField('Cargar Datos')\n\nclass FiltroMedicionesForm(FlaskForm):\n    fecha_desde = DateField('Desde', validators=[Optional()])\n    fecha_hasta = DateField('Hasta', validators=[Optional()])\n    tanque = SelectField('Tanque', coerce=int, validators=[Optional()])\n    tipo_medida = SelectField('Tipo', choices=[('', 'Todos'), ('rutinario', 'Rutinario'), ('cargue', 'Cargue'), ('descargue', 'Descargue')],\n                            validators=[Optional()])\n    empleado = SelectField('Empleado', coerce=int, validators=[Optional()])\n    submit = SubmitField('Filtrar')\n","path":null,"size_bytes":12318,"size_tokens":null},"utils.py":{"content":"# utils.py - ACTUALIZADO CON PERMISOS MEJORADOS PARA ENCARGADO\nfrom functools import wraps\nfrom flask import flash, redirect, url_for\nfrom flask_login import current_user\nfrom extensions import db\nfrom models import Auditoria\nimport json\n\n\ndef roles_required(*roles):\n    \"\"\"Decorador para verificar roles con auditor√≠a\"\"\"\n    def decorator(f):\n        @wraps(f)\n        def decorated_function(*args, **kwargs):\n            if not current_user.is_authenticated:\n                flash('Debe iniciar sesi√≥n para acceder a esta p√°gina', 'warning')\n                return redirect(url_for('auth.login'))\n\n            rol_usuario = (current_user.cargo_establecido or '').lower().strip()\n            roles_lower = [r.lower().strip() for r in roles]\n\n            if rol_usuario not in roles_lower:\n                flash(f'No tiene permisos. Se requiere rol: {\", \".join(roles)}', 'danger')\n                return redirect(url_for('dashboard.index'))\n\n            return f(*args, **kwargs)\n        return decorated_function\n    return decorator\n\n\ndef islero_or_encargado_required(f):\n    \"\"\"Permite que islero Y encargado registren medidas\"\"\"\n    return roles_required('islero', 'encargado', 'admin')(f)\n\n\ndef admin_or_encargado_required(f):\n    \"\"\"Decorador para admin o encargado - AMBOS TIENEN PERMISOS COMPLETOS\"\"\"\n    return roles_required('admin', 'encargado')(f)\n\n\ndef admin_required(f):\n    \"\"\"\n    Decorador solo para admin Y encargado\n    NOTA: Encargado tiene los mismos permisos que admin\n    \"\"\"\n    return roles_required('admin', 'encargado')(f)\n\n\ndef encargado_full_access(f):\n    \"\"\"\n    Nuevo decorador: Encargado tiene acceso completo (admin + islero)\n    \"\"\"\n    return roles_required('admin', 'encargado')(f)\n\n\ndef registrar_auditoria(accion, tabla, registro_id, datos_anteriores=None, datos_nuevos=None):\n    \"\"\"Registrar cambios en la auditor√≠a\"\"\"\n    try:\n        from flask import request\n        auditoria = Auditoria(\n            id_empleados=current_user.id_empleados if current_user.is_authenticated else None,\n            accion=accion,\n            tabla=tabla,\n            registro_id=registro_id,\n            datos_anteriores=json.dumps(datos_anteriores) if datos_anteriores else None,\n            datos_nuevos=json.dumps(datos_nuevos) if datos_nuevos else None,\n            ip_address=request.remote_addr if request else None\n        )\n        db.session.add(auditoria)\n        db.session.commit()\n    except Exception as e:\n        print(f\"Error al registrar auditor√≠a: {e}\")\n\n\ndef allowed_file(filename, allowed_extensions=None):\n    \"\"\"Verificar extensi√≥n de archivo\"\"\"\n    if allowed_extensions is None:\n        allowed_extensions = {'png', 'jpg', 'jpeg', 'gif', 'pdf'}\n    return '.' in filename and filename.rsplit('.', 1)[1].lower() in allowed_extensions","path":null,"size_bytes":2790,"size_tokens":null},"routes.py":{"content":"# routes.py - COMPLETO CON CONFIRMACI√ìN DE EMAIL\nfrom flask import Blueprint, render_template, request, redirect, url_for, flash, send_file, jsonify\nfrom flask_login import current_user, login_user, logout_user, login_required\nfrom flask_mail import Message\nfrom werkzeug.utils import secure_filename\nfrom datetime import date, datetime, timedelta\nfrom sqlalchemy import func, extract\nimport bcrypt\nimport os\nimport secrets\nimport pandas as pd\n\nfrom extensions import db, mail\nfrom models import Empleado, Tanque, Descargue, RegistroMedida, MedicionCargue, SesionActiva, Auditoria, Venta\nfrom forms import (LoginForm, RegisterForm, MedicionForm, DescargueForm, ChangePasswordForm, \n                  ResetPasswordForm, RequestPasswordResetForm, PasswordResetForm, TanqueForm,\n                  CargaMasivaForm, FiltroMedicionesForm)\nfrom utils import (islero_or_encargado_required, admin_or_encargado_required, admin_required,\n                  registrar_auditoria, allowed_file)\n\n# Blueprints\nauth_bp = Blueprint(\"auth\", __name__, url_prefix=\"/auth\")\nmain_bp = Blueprint(\"main\", __name__)\ndashboard_bp = Blueprint(\"dashboard\", __name__, url_prefix=\"/dashboard\")\nmedicion_bp = Blueprint(\"medicion\", __name__, url_prefix=\"/medicion\")\nadmin_bp = Blueprint(\"admin\", __name__, url_prefix=\"/admin\")\n\n# ============= FUNCIONES AUXILIARES =============\ndef enviar_email_confirmacion(empleado, token):\n    \"\"\"Enviar email de confirmaci√≥n al registrarse\"\"\"\n    confirm_url = url_for('auth.confirm_email', token=token, _external=True)\n    contrasena_temp = empleado.numero_documento[-4:] if len(empleado.numero_documento) >= 4 else empleado.numero_documento\n    \n    msg = Message(\"Confirma tu email - Hayuelos\",\n                recipients=[empleado.email])\n    msg.body = f\"\"\"Hola {empleado.nombre_empleado} {empleado.apellido_empleado},\n\n¬°Bienvenido a Sitex!\n\nPara completar tu registro, confirma tu email haciendo clic en el siguiente enlace:\n\n{confirm_url}\n\nEste enlace expira en 24 horas.\n\nTu usuario es: {empleado.usuario}\nTu contrase√±a temporal es: {contrasena_temp}\n\nPor seguridad, te recomendamos cambiar tu contrase√±a despu√©s de iniciar sesi√≥n.\n\nSi no te registraste en Hayuelos, ignora este correo.\n\nSaludos,\nSistema Hayuelos - \"Y Tambi√©n vendemos combustible\"\n\"\"\"\n    msg.html = f\"\"\"\n    <html>\n    <body style=\"font-family: Arial, sans-serif; line-height: 1.6; color: #333;\">\n        <div style=\"max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #ddd; border-radius: 10px;\">\n            <h2 style=\"color: #E10000;\">¬°Bienvenido a Hayuelos!</h2>\n            <p>Hola <strong>{empleado.nombre_empleado} {empleado.apellido_empleado}</strong>,</p>\n            <p>Gracias por registrarte en el sistema Hayuelos. Para completar tu registro, confirma tu email:</p>\n            \n            <div style=\"text-align: center; margin: 30px 0;\">\n                <a href=\"{confirm_url}\" \n                   style=\"background-color: #E10000; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; display: inline-block;\">\n                    Confirmar Email\n                </a>\n            </div>\n            \n            <div style=\"background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0;\">\n                <p><strong>Tus credenciales:</strong></p>\n                <p>Usuario: <code>{empleado.usuario}</code></p>\n                <p>Contrase√±a temporal: <code>{contrasena_temp}</code></p>\n            </div>\n            \n            <p style=\"color: #666; font-size: 0.9em;\">Este enlace expira en 24 horas.</p>\n            <p style=\"color: #666; font-size: 0.9em;\">Si no te registraste en Hayuelos, ignora este correo.</p>\n            \n            <hr style=\"margin: 30px 0; border: none; border-top: 1px solid #ddd;\">\n            <p style=\"color: #999; font-size: 0.8em; text-align: center;\">\n                Sistema Hayuelos - \"Y Tambi√©n vendemos combustible\"\n            </p>\n        </div>\n    </body>\n    </html>\n    \"\"\"\n    mail.send(msg)\n\ndef calcular_altura_maxima(capacidad_galones):\n    \"\"\"Calcular altura m√°xima en cm basada en capacidad del tanque\"\"\"\n    # Radio est√°ndar en cm (ajustar seg√∫n tanques reales)\n    radio_cm = 125  # 2.5m de di√°metro\n    \n    # Volumen en cm¬≥ = capacidad en galones * 3785.411784\n    volumen_cm3 = capacidad_galones * 3785.411784\n    \n    # Altura = Volumen / (œÄ * r¬≤)\n    area_base = 3.14159 * (radio_cm ** 2)\n    altura_cm = volumen_cm3 / area_base\n    \n    return round(altura_cm, 2)\n\n# ============= AUTH ROUTES =============\n@auth_bp.route(\"/login\", methods=[\"GET\", \"POST\"])\ndef login():\n    if current_user.is_authenticated:\n        return redirect(url_for(\"dashboard.index\"))\n\n    form = LoginForm()\n    if form.validate_on_submit():\n        usuario = form.username.data.strip()\n        contrasena = form.password.data\n\n        empleado = Empleado.query.filter(\n            (Empleado.usuario == usuario) | (Empleado.numero_documento == usuario)\n        ).first()\n\n        if empleado and empleado.check_password(contrasena):\n            if not empleado.activo:\n                flash(\"Su cuenta ha sido deshabilitada. Contacte al administrador.\", \"danger\")\n                return redirect(url_for(\"auth.login\"))\n\n            # NUEVO: Verificar si el email est√° confirmado\n            if not empleado.email_confirmado:\n                flash(\"Debe confirmar su email antes de iniciar sesi√≥n. Revise su correo electr√≥nico.\", \"warning\")\n                return redirect(url_for(\"auth.resend_confirmation\"))\n\n            login_user(empleado, remember=form.remember_me.data)\n            \n            # Crear sesi√≥n activa\n            session_id = secrets.token_urlsafe(32)\n            sesion = SesionActiva(\n                id_empleados=empleado.id_empleados,\n                session_id=session_id,\n                ip_address=request.remote_addr,\n                user_agent=request.headers.get('User-Agent', '')[:255]\n            )\n            db.session.add(sesion)\n            db.session.commit()\n\n            flash(f\"Bienvenido {empleado.nombre_empleado}!\", \"success\")\n            return redirect(url_for(\"dashboard.index\"))\n        else:\n            flash(\"Usuario o contrase√±a incorrectos\", \"danger\")\n\n    return render_template(\"auth/login.html\", form=form)\n\n@auth_bp.route(\"/register\", methods=[\"GET\", \"POST\"])\ndef register():\n    form = RegisterForm()\n    if form.validate_on_submit():\n        # Verificar duplicados\n        if Empleado.query.filter_by(numero_documento=form.numero_documento.data).first():\n            flash(\"El n√∫mero de documento ya est√° registrado\", \"danger\")\n            return render_template(\"auth/register.html\", form=form)\n        \n        if Empleado.query.filter_by(email=form.email.data).first():\n            flash(\"El email ya est√° registrado\", \"danger\")\n            return render_template(\"auth/register.html\", form=form)\n        \n        if Empleado.query.filter_by(usuario=form.usuario.data).first():\n            flash(\"El nombre de usuario ya est√° en uso\", \"danger\")\n            return render_template(\"auth/register.html\", form=form)\n\n        # Crear contrase√±a temporal\n        num_doc = form.numero_documento.data\n        contrasena_temporal = num_doc[-4:] if len(num_doc) >= 4 else num_doc\n        hash_cifrado = bcrypt.hashpw(contrasena_temporal.encode(\"utf-8\"), bcrypt.gensalt()).decode(\"utf-8\")\n\n        nuevo_empleado = Empleado(\n            usuario=form.usuario.data,\n            nombre_empleado=form.nombre_empleado.data,\n            apellido_empleado=form.apellido_empleado.data,\n            numero_documento=form.numero_documento.data,\n            tipo_documento=form.tipo_documento.data,\n            email=form.email.data,\n            telefono=form.telefono.data,\n            direccion=form.direccion.data,\n            cargo_establecido=form.cargo_establecido.data,\n            contrasena=hash_cifrado,\n            temporal=True,\n            activo=True,\n            email_confirmado=False,  # NO confirmado inicialmente\n            aceptado_terminos=form.aceptar_terminos.data\n        )\n        \n        # 1) Guardar usuario primero para que exista en la BD\n        db.session.add(nuevo_empleado)\n        db.session.commit()  # ahora tiene id y podemos generar/almacenar el token\n\n        # 2) Generar token y persistirlo (generate_confirmation_token escribe token en el objeto)\n        token = nuevo_empleado.generate_confirmation_token()\n        db.session.commit()  # persiste token_confirmacion y token_confirmacion_expiry\n\n        # 3) Intentar enviar email; loggear cualquier excepci√≥n para ver el error en Vercel\n        import traceback\n        try:\n            enviar_email_confirmacion(nuevo_empleado, token)\n            flash(f\"¬°Registro exitoso! Se ha enviado un email de confirmaci√≥n a {nuevo_empleado.email}.\", \"success\")\n        except Exception as e:\n            print(\"Error enviando email:\", e)\n            traceback.print_exc()\n            flash(\"Usuario creado, pero hubo un error al enviar el email. Contacte al administrador.\", \"warning\")\n        \n        # Auditor√≠a\n        registrar_auditoria('CREATE', 'empleado', nuevo_empleado.id_empleados, None, {\n            'usuario': nuevo_empleado.usuario,\n            'nombre': nuevo_empleado.nombre_empleado\n        })\n\n        return redirect(url_for(\"auth.login\"))\n\n    return render_template(\"auth/register.html\", form=form)\n\n# NUEVO: Ruta para confirmar email\n@auth_bp.route(\"/confirm/<token>\")\ndef confirm_email(token):\n    empleado = Empleado.query.filter_by(token_confirmacion=token).first()\n    \n    if not empleado:\n        flash(\"Token de confirmaci√≥n inv√°lido\", \"danger\")\n        return redirect(url_for(\"auth.login\"))\n    \n    if not empleado.verify_confirmation_token(token):\n        flash(\"El token de confirmaci√≥n ha expirado. Solicita un nuevo email de confirmaci√≥n.\", \"danger\")\n        return redirect(url_for(\"auth.resend_confirmation\"))\n    \n    empleado.confirmar_email()\n    db.session.commit()\n    \n    registrar_auditoria('CONFIRM_EMAIL', 'empleado', empleado.id_empleados, None, {\n        'email_confirmado': True\n    })\n    \n    flash(\"¬°Email confirmado exitosamente! Ya puedes iniciar sesi√≥n.\", \"success\")\n    return redirect(url_for(\"auth.login\"))\n\n# NUEVO: Reenviar email de confirmaci√≥n\n@auth_bp.route(\"/resend_confirmation\", methods=[\"GET\", \"POST\"])\ndef resend_confirmation():\n    if request.method == \"POST\":\n        email = request.form.get(\"email\")\n        empleado = Empleado.query.filter_by(email=email).first()\n        \n        if empleado:\n            if empleado.email_confirmado:\n                flash(\"Este email ya ha sido confirmado\", \"info\")\n                return redirect(url_for(\"auth.login\"))\n            \n            # Generar nuevo token\n            token = empleado.generate_confirmation_token()\n            db.session.commit()\n            \n            try:\n                enviar_email_confirmacion(empleado, token)\n                flash(\"Se ha enviado un nuevo email de confirmaci√≥n\", \"success\")\n            except Exception as e:\n                flash(f\"Error al enviar el email. Contacte al administrador.\", \"danger\")\n                print(f\"Error: {e}\")\n        else:\n            flash(\"Si el email existe en nuestro sistema, recibir√°s un enlace de confirmaci√≥n\", \"info\")\n    \n    return render_template(\"auth/resend_confirmation.html\")\n\n@auth_bp.route(\"/logout\")\n@login_required\ndef logout():\n    SesionActiva.query.filter_by(\n        id_empleados=current_user.id_empleados,\n        activa=True\n    ).update({'activa': False})\n    db.session.commit()\n    \n    logout_user()\n    flash(\"Sesi√≥n cerrada correctamente\", \"info\")\n    return redirect(url_for(\"auth.login\"))\n\n@auth_bp.route(\"/logout_all\", methods=[\"POST\"])\n@login_required\ndef logout_all():\n    SesionActiva.query.filter_by(id_empleados=current_user.id_empleados).update({'activa': False})\n    db.session.commit()\n    logout_user()\n    flash(\"Se han cerrado todas las sesiones activas\", \"success\")\n    return redirect(url_for(\"auth.login\"))\n\n@auth_bp.route(\"/change_password\", methods=[\"GET\", \"POST\"])\n@login_required\ndef change_password():\n    form = ChangePasswordForm()\n    if form.validate_on_submit():\n        if current_user.check_password(form.current_password.data):\n            hash_nuevo = bcrypt.hashpw(form.new_password.data.encode(\"utf-8\"), bcrypt.gensalt()).decode(\"utf-8\")\n            current_user.contrasena = hash_nuevo\n            current_user.temporal = False\n            db.session.commit()\n            \n            registrar_auditoria('UPDATE', 'empleado', current_user.id_empleados, \n                              {'temporal': True}, {'temporal': False})\n            \n            flash(\"Contrase√±a actualizada exitosamente\", \"success\")\n            return redirect(url_for(\"dashboard.index\"))\n        else:\n            flash(\"Contrase√±a actual incorrecta\", \"danger\")\n    \n    return render_template(\"auth/change_password.html\", form=form)\n\n@auth_bp.route(\"/request_reset\", methods=[\"GET\", \"POST\"])\ndef request_password_reset():\n    form = RequestPasswordResetForm()\n    if form.validate_on_submit():\n        empleado = Empleado.query.filter_by(email=form.email.data).first()\n        if empleado:\n            if not empleado.email_confirmado:\n                flash(\"Primero debe confirmar su email. Revise su correo.\", \"warning\")\n                return redirect(url_for(\"auth.resend_confirmation\"))\n            \n            token = empleado.generate_reset_token()\n            db.session.commit()\n            \n            reset_url = url_for('auth.reset_password', token=token, _external=True)\n            msg = Message(\"Recuperaci√≥n de Contrase√±a - Hayuelos\",\n                        recipients=[empleado.email])\n            msg.body = f\"\"\"Hola {empleado.nombre_empleado},\n\nHas solicitado restablecer tu contrase√±a. Haz clic en el siguiente enlace:\n\n{reset_url}\n\nEste enlace expira en 1 hora.\n\nSi no solicitaste este cambio, ignora este correo.\n\nSaludos,\nSistema Hayuelos\n\"\"\"\n            msg.html = f\"\"\"\n            <html>\n            <body style=\"font-family: Arial, sans-serif; line-height: 1.6; color: #333;\">\n                <div style=\"max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #ddd; border-radius: 10px;\">\n                    <h2 style=\"color: #E10000;\">Recuperaci√≥n de Contrase√±a</h2>\n                    <p>Hola <strong>{empleado.nombre_empleado}</strong>,</p>\n                    <p>Has solicitado restablecer tu contrase√±a en Hayuelos.</p>\n                    \n                    <div style=\"text-align: center; margin: 30px 0;\">\n                        <a href=\"{reset_url}\" \n                           style=\"background-color: #E10000; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; display: inline-block;\">\n                            Restablecer Contrase√±a\n                        </a>\n                    </div>\n                    \n                    <p style=\"color: #666; font-size: 0.9em;\">Este enlace expira en 1 hora.</p>\n                    <p style=\"color: #666; font-size: 0.9em;\">Si no solicitaste este cambio, ignora este correo.</p>\n                    \n                    <hr style=\"margin: 30px 0; border: none; border-top: 1px solid #ddd;\">\n                    <p style=\"color: #999; font-size: 0.8em; text-align: center;\">\n                        Sistema Hayuelos\n                    </p>\n                </div>\n            </body>\n            </html>\n            \"\"\"\n            try:\n                mail.send(msg)\n                flash(\"Se ha enviado un enlace de recuperaci√≥n a tu email\", \"success\")\n            except Exception as e:\n                flash(f\"Error al enviar el email. Contacte al administrador.\", \"danger\")\n                print(f\"Error: {e}\")\n        else:\n            flash(\"Si el email existe en nuestro sistema, recibir√°s un enlace de recuperaci√≥n\", \"info\")\n    \n    return render_template(\"auth/request_reset.html\", form=form)\n\n@auth_bp.route(\"/reset/<token>\", methods=[\"GET\", \"POST\"])\ndef reset_password(token):\n    empleado = Empleado.query.filter_by(reset_token=token).first()\n    if not empleado or not empleado.verify_reset_token(token):\n        flash(\"Token inv√°lido o expirado\", \"danger\")\n        return redirect(url_for(\"auth.request_password_reset\"))\n    \n    form = PasswordResetForm()  # üëà El formulario debe estar aqu√≠\n    \n    if form.validate_on_submit():\n        hash_nuevo = bcrypt.hashpw(form.password.data.encode(\"utf-8\"), bcrypt.gensalt()).decode(\"utf-8\")\n        empleado.contrasena = hash_nuevo\n        empleado.reset_token = None\n        empleado.reset_token_expiry = None\n        empleado.temporal = False\n        db.session.commit()\n        \n        registrar_auditoria('RESET_PASSWORD', 'empleado', empleado.id_empleados, None, {\n            'password_reset': True\n        })\n        \n        flash(\"Contrase√±a restablecida exitosamente\", \"success\")\n        return redirect(url_for(\"auth.login\"))\n    \n    return render_template(\"auth/reset_password.html\", form=form)  # üëà Pasando el form\n\n@auth_bp.route(\"/reset_password/<int:empleado_id>\", methods=[\"POST\"])\n@login_required\n@admin_or_encargado_required\ndef reset_password_admin(empleado_id):\n    empleado = Empleado.query.get_or_404(empleado_id)\n    \n    contrasena_temporal = empleado.numero_documento[-4:] if len(empleado.numero_documento) >= 4 else empleado.numero_documento\n    hash_cifrado = bcrypt.hashpw(contrasena_temporal.encode(\"utf-8\"), bcrypt.gensalt()).decode(\"utf-8\")\n    \n    empleado.contrasena = hash_cifrado\n    empleado.temporal = True\n    db.session.commit()\n    \n    registrar_auditoria('UPDATE', 'empleado', empleado_id, None, {'reset_password': True})\n    \n    flash(f\"Contrase√±a restablecida para {empleado.nombre_empleado}. Nueva contrase√±a: {contrasena_temporal}\", \"success\")\n    return redirect(url_for(\"dashboard.empleados\"))\n\n@auth_bp.route(\"/resetear-clave/<int:empleado_id>\", methods=[\"POST\"])\n@login_required\n@admin_required\ndef resetear_clave_empleado(empleado_id):\n    empleado = Empleado.query.get_or_404(empleado_id)\n    \n    temp_password = empleado.numero_documento[-4:] if len(empleado.numero_documento) >= 4 else empleado.numero_documento\n    hashed = bcrypt.hashpw(temp_password.encode('utf-8'), bcrypt.gensalt()).decode('utf-8')\n    \n    empleado.contrasena = hashed\n    empleado.temporal = True\n    db.session.commit()\n    \n    flash(f'Contrase√±a reseteada para {empleado.usuario}. Nueva: {temp_password}', 'warning')\n    registrar_auditoria('reset_password', 'empleado', empleado.id_empleados, None, {'temporal': True})\n    \n    return redirect(url_for('dashboard.empleados'))\n\n# ============= MAIN ROUTES =============\n@main_bp.route(\"/\")\ndef home():\n    if current_user.is_authenticated:\n        return redirect(url_for(\"dashboard.index\"))\n    return redirect(url_for(\"auth.login\"))\n\n@main_bp.route(\"/terminos\")\ndef terminos():\n    return render_template(\"terminos.html\")\n\n@main_bp.route(\"/privacidad\")\ndef privacidad():\n    return render_template(\"privacidad.html\")\n\n# ============= DASHBOARD ROUTES =============\n@dashboard_bp.route(\"/\")\n@login_required\ndef index():\n    tanques = Tanque.query.filter_by(activo=True).all()\n    total_capacity = sum(float(t.capacidad) for t in tanques) if tanques else 0\n    mediciones_recientes = RegistroMedida.query.order_by(\n        RegistroMedida.fecha_hora_registro.desc()\n    ).limit(5).all()\n    descargues_hoy = Descargue.query.filter_by(fecha=date.today()).all()\n\n    tanques_por_tipo = {}\n    for tanque in tanques:\n        tipo = tanque.tipo_combustible\n        if tipo not in tanques_por_tipo:\n            tanques_por_tipo[tipo] = {\"count\": 0, \"capacity\": 0, \"current\": 0}\n        tanques_por_tipo[tipo][\"count\"] += 1\n        tanques_por_tipo[tipo][\"capacity\"] += float(tanque.capacidad)\n        tanques_por_tipo[tipo][\"current\"] += tanque.contenido or 0\n\n    combustible_mas_vendido = db.session.query(\n        Tanque.tipo_combustible,\n        func.sum(Venta.cantidad_galones).label('total')\n    ).join(Venta).group_by(Tanque.tipo_combustible).order_by(func.sum(Venta.cantidad_galones).desc()).first()\n\n    ventas_por_mes = db.session.query(\n        extract('month', Venta.fecha).label('mes'),\n        func.sum(Venta.cantidad_galones).label('total')\n    ).group_by('mes').order_by(func.sum(Venta.cantidad_galones).desc()).all()\n\n    context = {\n        \"tanques\": tanques,\n        \"total_capacity\": total_capacity,\n        \"mediciones_recientes\": mediciones_recientes,\n        \"descargues_hoy\": descargues_hoy,\n        \"tanques_por_tipo\": tanques_por_tipo,\n        \"total_tanques\": len(tanques),\n        \"combustible_mas_vendido\": combustible_mas_vendido,\n        \"ventas_por_mes\": ventas_por_mes\n    }\n    return render_template(\"dashboard/index.html\", **context)\n\n@dashboard_bp.route(\"/tanques\")\n@login_required\ndef tanques():\n    \"\"\"Mostrar TODOS los tanques (activos e inactivos)\"\"\"\n    # ‚ùå ANTES: tanques = Tanque.query.filter_by(activo=True).all()\n    # ‚úÖ AHORA: Mostrar todos los tanques, ordenados por activo primero\n    \n    tanques = Tanque.query.order_by(\n        Tanque.activo.desc(),  # Activos primero\n        Tanque.id_tanques.asc()  # Luego por ID\n    ).all()\n    \n    return render_template(\"dashboard/tanques.html\", tanques=tanques)\n\n@dashboard_bp.route(\"/empleados\")\n@login_required\n@admin_or_encargado_required\ndef empleados():\n    empleados = Empleado.query.all()\n    return render_template(\"dashboard/empleados.html\", empleados=empleados)\n\n# routes.py - FUNCI√ìN estadisticas() CORREGIDA\n# Reemplaza SOLO esta funci√≥n en tu routes.py\n\n@dashboard_bp.route(\"/estadisticas\")\n@login_required\ndef estadisticas():\n    \"\"\"Dashboard de estad√≠sticas paginado - VERSI√ìN CORREGIDA\"\"\"\n    from collections import OrderedDict\n    \n    page = request.args.get('page', 1, type=int)\n    per_page = 5\n    \n    # ===== ESTAD√çSTICA 1: GALONES CARGADOS POR SEMANA =====\n    hoy = datetime.now()\n    hace_8_semanas = hoy - timedelta(weeks=8)\n    \n    cargues = MedicionCargue.query.filter(\n        MedicionCargue.fecha >= hace_8_semanas\n    ).all()\n    \n    galones_por_semana = OrderedDict()\n    for cargue in cargues:\n        if cargue.fecha:\n            semana = cargue.fecha.isocalendar()[1]\n            a√±o = cargue.fecha.year\n            key = f\"{a√±o}-W{semana:02d}\"\n            \n            try:\n                galones = float(cargue.galones_totales or 0)\n                galones_por_semana[key] = galones_por_semana.get(key, 0) + galones\n            except (ValueError, TypeError):\n                continue\n    \n    # ===== ESTAD√çSTICA 2: GALONES CARGADOS POR MES =====\n    hace_12_meses = hoy - timedelta(days=365)\n    \n    cargues_mes = MedicionCargue.query.filter(\n        MedicionCargue.fecha >= hace_12_meses\n    ).all()\n    \n    galones_por_mes = OrderedDict()\n    for cargue in cargues_mes:\n        if cargue.fecha:\n            key = cargue.fecha.strftime('%Y-%m')\n            mes_nombre = cargue.fecha.strftime('%B %Y')\n            \n            try:\n                galones = float(cargue.galones_totales or 0)\n                if key not in galones_por_mes:\n                    galones_por_mes[key] = {\n                        'nombre': mes_nombre,\n                        'galones': 0\n                    }\n                galones_por_mes[key]['galones'] += galones\n            except (ValueError, TypeError):\n                continue\n    \n    # ===== ESTAD√çSTICA 3: GALONES VENDIDOS (DIFERENCIA DE MEDICIONES) =====\n    ventas_por_tipo = OrderedDict()\n    \n    tanques = Tanque.query.filter_by(activo=True).all()\n    \n    for tanque in tanques:\n        mediciones = RegistroMedida.query.filter(\n            RegistroMedida.id_tanques == tanque.id_tanques,\n            RegistroMedida.fecha_hora_registro >= hoy - timedelta(days=30)\n        ).order_by(RegistroMedida.fecha_hora_registro.asc()).all()\n        \n        total_vendido = 0\n        for i in range(1, len(mediciones)):\n            medicion_anterior = mediciones[i-1]\n            medicion_actual = mediciones[i]\n            \n            try:\n                galones_anterior = float(medicion_anterior.galones or 0)\n                galones_actual = float(medicion_actual.galones or 0)\n                \n                diferencia = galones_anterior - galones_actual\n                if diferencia > 0:\n                    total_vendido += diferencia\n            except (ValueError, TypeError):\n                continue\n        \n        if total_vendido > 0:\n            tipo = tanque.tipo_combustible\n            ventas_por_tipo[tipo] = ventas_por_tipo.get(tipo, 0) + total_vendido\n    \n    # ===== ESTAD√çSTICA 4: TOTAL CARGADO VS VENDIDO (√öLTIMO MES) =====\n    total_cargado_mes = sum([v['galones'] for v in galones_por_mes.values()])\n    total_vendido_mes = sum(ventas_por_tipo.values())\n    \n    # ===== ESTAD√çSTICA 5: PROMEDIO DE MEDICIONES POR D√çA =====\n    hace_30_dias = hoy - timedelta(days=30)\n    \n    mediciones_diarias = db.session.query(\n        func.date(RegistroMedida.fecha_hora_registro).label('fecha'),\n        func.count(RegistroMedida.id_registro_medidas).label('cantidad')\n    ).filter(\n        RegistroMedida.fecha_hora_registro >= hace_30_dias\n    ).group_by(\n        func.date(RegistroMedida.fecha_hora_registro)\n    ).all()\n    \n    total_mediciones = sum([m.cantidad for m in mediciones_diarias])\n    promedio_mediciones = total_mediciones / max(len(mediciones_diarias), 1)\n    \n    # ===== PREPARAR DATOS PARA PAGINACI√ìN =====\n    estadisticas = [\n        {\n            'numero': 1,\n            'titulo': 'Galones Cargados por Semana',\n            'descripcion': 'Cargues de emergencia de las √∫ltimas 8 semanas',\n            'tipo': 'bar',\n            'datos': dict(galones_por_semana),  # Convertir a dict normal\n            'unidad': 'galones'\n        },\n        {\n            'numero': 2,\n            'titulo': 'Galones Cargados por Mes',\n            'descripcion': 'Hist√≥rico de cargues de los √∫ltimos 12 meses',\n            'tipo': 'line',\n            'datos': dict(galones_por_mes),  # Convertir a dict normal\n            'unidad': 'galones'\n        },\n        {\n            'numero': 3,\n            'titulo': 'Galones Vendidos por Tipo de Combustible',\n            'descripcion': 'Ventas calculadas del √∫ltimo mes',\n            'tipo': 'pie',\n            'datos': dict(ventas_por_tipo),  # Convertir a dict normal\n            'unidad': 'galones'\n        },\n        {\n            'numero': 4,\n            'titulo': 'Comparativa: Cargado vs Vendido',\n            'descripcion': 'Balance del √∫ltimo mes',\n            'tipo': 'comparison',\n            'datos': {\n                'cargado': float(total_cargado_mes),\n                'vendido': float(total_vendido_mes),\n                'diferencia': float(total_cargado_mes - total_vendido_mes)\n            },\n            'unidad': 'galones'\n        },\n        {\n            'numero': 5,\n            'titulo': 'Promedio de Mediciones Diarias',\n            'descripcion': 'Actividad promedio de los √∫ltimos 30 d√≠as',\n            'tipo': 'metric',\n            'datos': {\n                'promedio': round(promedio_mediciones, 2),\n                'total_dias': len(mediciones_diarias),\n                'total_mediciones': total_mediciones\n            },\n            'unidad': 'mediciones/d√≠a'\n        }\n    ]\n    \n    # ===== PAGINACI√ìN =====\n    total_estadisticas = len(estadisticas)\n    total_pages = (total_estadisticas + per_page - 1) // per_page\n    \n    start = (page - 1) * per_page\n    end = start + per_page\n    estadisticas_paginadas = estadisticas[start:end]\n    \n    # ===== DEBUG: Imprimir datos en consola del servidor =====\n    print(\"\\n\" + \"=\"*60)\n    print(\"üìä DEBUG ESTAD√çSTICAS\")\n    print(\"=\"*60)\n    print(f\"P√°gina actual: {page}/{total_pages}\")\n    print(f\"Estad√≠sticas en esta p√°gina: {len(estadisticas_paginadas)}\")\n    \n    for stat in estadisticas_paginadas:\n        print(f\"\\n--- Estad√≠stica {stat['numero']}: {stat['titulo']} ---\")\n        print(f\"Tipo: {stat['tipo']}\")\n        print(f\"Datos: {stat['datos']}\")\n        if stat['tipo'] in ['bar', 'line', 'pie']:\n            print(f\"Cantidad de datos: {len(stat['datos'])}\")\n    \n    print(\"=\"*60 + \"\\n\")\n    \n    return render_template(\n        'dashboard/estadisticas.html',\n        estadisticas=estadisticas_paginadas,\n        page=page,\n        total_pages=total_pages,\n        per_page=per_page\n    )\n\n\n# ===== RUTAS PARA MANUALES Y POL√çTICAS =====\n\n@main_bp.route(\"/manual-usuario\")\n@login_required\ndef manual_usuario():\n    \"\"\"Manual de usuario (pendiente de subir)\"\"\"\n    return render_template(\"documentacion/manual_usuario.html\")\n\n\n@main_bp.route(\"/manual-tecnico\")\n@login_required\ndef manual_tecnico():\n    \"\"\"Manual t√©cnico (pendiente de subir)\"\"\"\n    return render_template(\"documentacion/manual_tecnico.html\")\n\n\n@main_bp.route(\"/politicas\")\n@login_required\ndef politicas():\n    \"\"\"Pol√≠ticas de la empresa (pendiente de subir)\"\"\"\n    return render_template(\"documentacion/politicas.html\")\n\n# ============= MEDICION ROUTES =============\n@medicion_bp.route(\"/registro\", methods=[\"GET\", \"POST\"])\n@login_required\n@islero_or_encargado_required\ndef registro():\n    form = MedicionForm()\n    tanques = Tanque.query.filter_by(activo=True).all()\n    form.tanque.choices = [(t.id_tanques, f\"{t.tipo_combustible} - Tanque {t.id_tanques}\") for t in tanques]\n    \n    if form.validate_on_submit():\n        tanque_seleccionado = Tanque.query.get(form.tanque.data)\n        \n        # Fix: Compute altura_maxima_cm if None\n        if tanque_seleccionado.altura_maxima_cm is None:\n            tanque_seleccionado.altura_maxima_cm = calcular_altura_maxima(tanque_seleccionado.capacidad)\n            db.session.commit()  # Save the update to DB\n        \n        medida_str = form.medida_combustible.data.replace(',', '.')\n        medida_cm = float(medida_str)\n        \n        # Fix: Only compare if altura_maxima_cm is not None (though we just set it)\n        if tanque_seleccionado.altura_maxima_cm is not None and medida_cm > tanque_seleccionado.altura_maxima_cm:\n            flash(\n                f\"‚ùå La medida ({medida_cm} cm) supera la altura m√°xima del tanque ({tanque_seleccionado.altura_maxima_cm} cm)\", \n                \"danger\"\n            )\n            return render_template(\"medicion/registro.html\", form=form)\n        \n        # Rest of the code remains the same...\n    if form.validate_on_submit():\n        imagen_path = None\n        if form.imagen.data:\n            file = form.imagen.data\n            if allowed_file(file.filename):\n                filename = secure_filename(f\"{datetime.now().strftime('%Y%m%d%H%M%S')}_{file.filename}\")\n                filepath = os.path.join('static/uploads', filename)\n                os.makedirs('static/uploads', exist_ok=True)\n                file.save(filepath)\n                imagen_path = filename\n\n        medicion = RegistroMedida(\n            medida_combustible=form.medida_combustible.data,\n            id_empleados=current_user.id_empleados,\n            fecha_hora_registro=datetime.now(),\n            galones=form.galones.data,\n            id_tanques=form.tanque.data,\n            tipo_medida=form.tipo_medida.data,\n            novedad=form.novedad.data,\n            imagen_path=imagen_path\n        )\n        db.session.add(medicion)\n        db.session.commit()\n        \n        registrar_auditoria('CREATE', 'registro_medidas', medicion.id_registro_medidas, None, {\n            'tanque': form.tanque.data,\n            'galones': form.galones.data\n        })\n\n        flash(\"Medici√≥n registrada exitosamente\", \"success\")\n        return redirect(url_for(\"medicion.historial\"))\n\n    return render_template(\"medicion/registro.html\", form=form)\n\n@medicion_bp.route(\"/historial\")\n@login_required\ndef historial():\n    page = request.args.get(\"page\", 1, type=int)\n    \n    query = RegistroMedida.query\n    \n    fecha_desde = request.args.get('fecha_desde')\n    fecha_hasta = request.args.get('fecha_hasta')\n    tanque_id = request.args.get('tanque', type=int)\n    tipo = request.args.get('tipo')\n    \n    if fecha_desde:\n        query = query.filter(RegistroMedida.fecha_hora_registro >= fecha_desde)\n    if fecha_hasta:\n        query = query.filter(RegistroMedida.fecha_hora_registro <= fecha_hasta)\n    if tanque_id:\n        query = query.filter_by(id_tanques=tanque_id)\n    if tipo:\n        query = query.filter_by(tipo_medida=tipo)\n    \n    mediciones = query.order_by(\n        RegistroMedida.fecha_hora_registro.desc()\n    ).paginate(page=page, per_page=20, error_out=False)\n    \n    tanques = Tanque.query.filter_by(activo=True).all()\n    return render_template(\"medicion/historial.html\", mediciones=mediciones, tanques=tanques)\n\n@medicion_bp.route(\"/descargue\", methods=[\"GET\", \"POST\"])\n@login_required\n@islero_or_encargado_required\ndef descargue():\n    form = DescargueForm()\n\n    # Cargar tanques activos\n    tanques = Tanque.query.filter_by(activo=True).all()\n    form.tanque.choices = [(t.id_tanques, f\"{t.tipo_combustible} - Tanque {t.id_tanques}\") for t in tanques]\n\n    if form.validate_on_submit():\n        tanque_seleccionado = Tanque.query.get(form.tanque.data)\n\n        # CORREGIDO: Calcular altura m√°xima si est√° vac√≠a\n        if tanque_seleccionado.altura_maxima_cm is None:\n            tanque_seleccionado.altura_maxima_cm = calcular_altura_maxima(tanque_seleccionado.capacidad)\n            db.session.commit()\n\n        try:\n            medida_inicial_cm = float(str(form.medida_inicial_cm.data).replace(',', '.'))\n            descargue_cm_valor = float(str(form.descargue_cm.data).replace(',', '.'))\n            medida_final_cm = float(str(form.medida_final_cm.data).replace(',', '.'))\n        except (ValueError, AttributeError) as e:\n            flash(\"Error en los valores de medidas (cm). Verifica que sean n√∫meros v√°lidos.\", \"danger\")\n            return render_template(\"medicion/descargue.html\", form=form)\n\n        # Validaciones de altura m√°xima\n        if medida_inicial_cm > tanque_seleccionado.altura_maxima_cm:\n            flash(f\"Medida inicial ({medida_inicial_cm} cm) supera la altura m√°xima del tanque ({tanque_seleccionado.altura_maxima_cm:.2f} cm)\", \"danger\")\n            return render_template(\"medicion/descargue.html\", form=form)\n\n        if medida_final_cm > tanque_seleccionado.altura_maxima_cm:\n            flash(f\"Medida final ({medida_final_cm} cm) supera la altura m√°xima del tanque ({tanque_seleccionado.altura_maxima_cm:.2f} cm)\", \"danger\")\n            return render_template(\"medicion/descargue.html\", form=form)\n\n        # Guardar imagen si existe\n        imagen_path = None\n        if form.imagen.data:\n            file = form.imagen.data\n            if allowed_file(file.filename):\n                filename = secure_filename(f\"{datetime.now().strftime('%Y%m%d%H%M%S')}_{file.filename}\")\n                filepath = os.path.join('static/uploads', filename)\n                os.makedirs('static/uploads', exist_ok=True)\n                file.save(filepath)\n                imagen_path = filename\n\n        # Crear el descargue\n        descargue_obj = Descargue(\n            id_empleados=current_user.id_empleados,\n            medida_inicial_cm=form.medida_inicial_cm.data,\n            medida_inicial_gl=form.medida_inicial_gl.data,\n            descargue_cm=form.descargue_cm.data,\n            descargue_gl=form.descargue_gl.data,\n            medida_final_cm=form.medida_final_cm.data,\n            medida_final_gl=form.medida_final_gl.data,\n            diferencia=form.diferencia.data,\n            tanque=form.tanque.data,\n            observaciones1=form.observaciones1.data,\n            observaciones2=form.observaciones2.data,\n            kit_derrames='si' if form.kit_derrames.data else 'no',\n            extintores='si' if form.extintores.data else 'no',\n            conos='si' if form.conos.data else 'no',\n            boquillas='si' if form.boquillas.data else 'no',\n            botas='si' if form.botas.data else 'no',\n            gafas='si' if form.gafas.data else 'no',\n            tapaoidos='si' if form.tapaoidos.data else 'no',\n            guantes='si' if form.guantes.data else 'no',\n            brillante=form.brillante.data,\n            traslucido=form.traslucido.data,\n            claro=form.claro.data,\n            solidos=form.solidos.data,\n            separacion=form.separacion.data,\n            fecha=form.fecha.data or date.today(),\n            imagen_path=imagen_path\n        )\n        db.session.add(descargue_obj)\n        db.session.commit()\n\n        registrar_auditoria('CREATE', 'descargues', descargue_obj.idDescargue, None, {\n            'tanque': form.tanque.data,\n            'galones_descargados': form.diferencia.data\n        })\n\n        flash(\"Descargue registrado exitosamente\", \"success\")\n        return redirect(url_for(\"medicion.historial_descargues\"))\n\n    return render_template(\"medicion/descargue.html\", form=form)\n\n@medicion_bp.route(\"/api/convert_cm_to_gallons/<int:tanque_id>\", methods=[\"GET\"])\n@login_required\ndef convert_cm_to_gallons(tanque_id):\n    \"\"\"API para convertir cm a galones seg√∫n el tanque espec√≠fico\"\"\"\n    cm = request.args.get('cm', type=float, default=0)\n    \n    tanque = Tanque.query.get_or_404(tanque_id)\n    \n    # Fix: Use tanque.radio_cm (from DB) instead of non-existent diametro_m\n    radio_cm = tanque.radio_cm if tanque.radio_cm else 125  # Fallback to default if None\n    \n    # F√≥rmula correcta: V = œÄ * r¬≤ * h\n    # 1 gal√≥n = 3785.411784 cm¬≥\n    area_base = 3.14159 * (radio_cm ** 2)  # cm¬≤\n    volumen_cm3 = area_base * cm  # cm¬≥\n    galones = volumen_cm3 / 3785.411784\n    \n    return jsonify({\n        'cm': cm,\n        'gallons': round(galones, 2),\n        'tanque_id': tanque_id,\n        'radio_cm': radio_cm\n    })\n\n@medicion_bp.route(\"/historial_descargues\")\n@login_required\ndef historial_descargues():\n    page = request.args.get(\"page\", 1, type=int)\n    descargues = Descargue.query.order_by(Descargue.fecha.desc()).paginate(\n        page=page, per_page=20, error_out=False\n    )\n    return render_template(\"medicion/historial_descargues.html\", descargues=descargues)\n\n# ============= ADMIN ROUTES =============\n@admin_bp.route(\"/toggle_empleado/<int:empleado_id>\", methods=[\"POST\"])\n@login_required\n@admin_required\ndef toggle_empleado(empleado_id):\n    empleado = Empleado.query.get_or_404(empleado_id)\n    empleado.activo = not empleado.activo\n    db.session.commit()\n    \n    registrar_auditoria('UPDATE', 'empleado', empleado_id, \n                      {'activo': not empleado.activo}, {'activo': empleado.activo})\n    \n    estado = \"habilitado\" if empleado.activo else \"deshabilitado\"\n    flash(f\"Empleado {empleado.nombre_empleado} {estado}\", \"success\")\n    return redirect(url_for(\"dashboard.empleados\"))\n\n@admin_bp.route(\"/carga_masiva\", methods=[\"GET\", \"POST\"])\n@login_required\n@admin_required\ndef carga_masiva():\n    form = CargaMasivaForm()\n    if form.validate_on_submit():\n        file = form.archivo.data\n        tipo_carga = form.tipo_carga.data\n        \n        if not file or not allowed_file(file.filename, {'csv', 'xlsx', 'xls'}):\n            flash(\"Archivo inv√°lido\", \"danger\")\n            return redirect(request.url)\n\n        try:\n            if file.filename.lower().endswith('.csv'):\n                df = pd.read_csv(file, sep=',', decimal='.', encoding='utf-8-sig')\n            else:\n                df = pd.read_excel(file)\n            \n            df = df.apply(lambda x: x.str.strip() if x.dtype == \"object\" else x)\n            df.replace({\"True\": True, \"False\": False}, inplace=True, regex=True)\n\n            count = 0\n            errors = []\n\n            if tipo_carga == 'empleados':\n                required = ['nombre_empleado', 'apellido_empleado', 'numero_documento', 'email', 'usuario']\n                if not all(col in df.columns for col in required):\n                    flash(f\"Faltan columnas: {', '.join(required)}\", \"danger\")\n                    return redirect(request.url)\n                \n                for idx, row in df.iterrows():\n                    if Empleado.query.filter_by(numero_documento=row['numero_documento']).first():\n                        errors.append(f\"Fila {idx+2}: Documento duplicado\")\n                        continue\n                    if Empleado.query.filter_by(usuario=row['usuario']).first():\n                        errors.append(f\"Fila {idx+2}: Usuario duplicado\")\n                        continue\n                    \n                    temp_pass = str(row['numero_documento'])[-4:]\n                    hash_pwd = bcrypt.hashpw(temp_pass.encode(), bcrypt.gensalt()).decode()\n                    \n                    empleado = Empleado(\n                        nombre_empleado=row['nombre_empleado'],\n                        apellido_empleado=row['apellido_empleado'],\n                        numero_documento=row['numero_documento'],\n                        tipo_documento=row.get('tipo_documento', 'CC'),\n                        email=row['email'],\n                        telefono=row.get('telefono', ''),\n                        direccion=row.get('direccion', ''),\n                        cargo_establecido=row.get('cargo_establecido', 'Islero'),\n                        usuario=row['usuario'],\n                        contrasena=hash_pwd,\n                        temporal=True,\n                        activo=row.get('activo', True),\n                        email_confirmado=True,  # Carga masiva: emails pre-confirmados\n                        aceptado_terminos=row.get('aceptado_terminos', False)\n                    )\n                    db.session.add(empleado)\n                    count += 1\n\n            elif tipo_carga == 'tanques':\n                required = ['tipo_combustible', 'capacidad']\n                if not all(col in df.columns for col in required):\n                    flash(\"Faltan columnas: tipo_combustible, capacidad\", \"danger\")\n                    return redirect(request.url)\n                \n                for idx, row in df.iterrows():\n                    try:\n                        capacidad = int(float(str(row['capacidad']).replace(',', '.')))\n                        tanque = Tanque(\n                            tipo_combustible=row['tipo_combustible'],\n                            capacidad=capacidad,\n                            activo=row.get('activo', True)\n                        )\n                        db.session.add(tanque)\n                        count += 1\n                    except Exception as e:\n                        errors.append(f\"Fila {idx+2}: Capacidad inv√°lida ‚Üí {str(e)}\")\n\n            elif tipo_carga == 'mediciones':\n                required = ['tanque_id', 'medida_combustible', 'galones', 'tipo_medida', 'fecha_hora_registro', 'empleado_id']\n                if not all(col in df.columns for col in required):\n                    flash(\"Faltan columnas en mediciones\", \"danger\")\n                    return redirect(request.url)\n                \n                for idx, row in df.iterrows():\n                    try:\n                        tanque_id = int(row['tanque_id'])\n                        empleado_id = int(row['empleado_id'])\n                        tanque = Tanque.query.get(tanque_id)\n                        empleado = Empleado.query.get(empleado_id)\n                        \n                        if not tanque:\n                            errors.append(f\"Fila {idx+2}: tanque_id {tanque_id} no existe\")\n                            continue\n                        if not empleado:\n                            errors.append(f\"Fila {idx+2}: empleado_id {empleado_id} no existe\")\n                            continue\n                        \n                        medida_str = str(row['medida_combustible']).replace(',', '.')\n                        galones_str = str(row['galones']).replace(',', '.')\n                        medida = float(medida_str)\n                        galones = float(galones_str)\n                        \n                        fecha_str = str(row['fecha_hora_registro']).strip()\n                        try:\n                            fecha = datetime.strptime(fecha_str, '%Y-%m-%d %H:%M:%S')\n                        except:\n                            fecha = datetime.strptime(fecha_str, '%Y-%m-%d %H:%M')\n                        \n                        medicion = RegistroMedida(\n                            id_tanques=tanque.id_tanques,\n                            id_empleados=empleado.id_empleados,\n                            medida_combustible=medida,\n                            galones=galones,\n                            tipo_medida=row['tipo_medida'],\n                            novedad=row.get('novedad', ''),\n                            fecha_hora_registro=fecha\n                        )\n                        db.session.add(medicion)\n                        count += 1\n                    except Exception as e:\n                        errors.append(f\"Fila {idx+2}: Error ‚Üí {str(e)}\")\n\n            db.session.commit()\n            registrar_auditoria('CREATE_BULK', tipo_carga, None, None, {'count': count})\n\n            msg = f\"Se cargaron {count} registros exitosamente\"\n            if errors:\n                error_sample = \"; \".join(errors[:3])\n                flash(f\"{msg}. Errores: {len(errors)} ‚Üí {error_sample}\", \"warning\")\n            else:\n                flash(msg, \"success\")\n\n        except Exception as e:\n            db.session.rollback()\n            flash(f\"Error cr√≠tico: {str(e)}\", \"danger\")\n            print(f\"[ERROR] {e}\")\n\n    return render_template(\"admin/carga_masiva.html\", form=form)\n\n\n# ============= EXPORT ROUTES (AGREGAR AL FINAL DE routes.py) =============\n\n@admin_bp.route(\"/export_menu\", methods=[\"GET\"])\n@login_required\n@admin_or_encargado_required\ndef export_menu():\n    \"\"\"Men√∫ de exportaci√≥n de datos\"\"\"\n    tanques = Tanque.query.filter_by(activo=True).all()\n    return render_template(\"admin/export_menu.html\", tanques=tanques)\n\n\n@admin_bp.route(\"/export/<tipo>\", methods=[\"GET\"])\n@login_required\n@admin_or_encargado_required\ndef export_data(tipo):\n    \"\"\"Exportar datos en formato Excel o CSV\"\"\"\n    from io import BytesIO\n    try:\n        import openpyxl\n        from openpyxl.styles import Font, PatternFill, Alignment\n    except ImportError:\n        flash(\"Error: Instale openpyxl con 'pip install openpyxl'\", \"danger\")\n        return redirect(url_for('dashboard.index'))\n    \n    formato = request.args.get('formato', 'excel')  # 'excel' o 'csv'\n    \n    # Determinar qu√© datos exportar\n    if tipo == 'empleados':\n        empleados = Empleado.query.all()\n        data = []\n        headers = ['ID', 'Usuario', 'Nombre', 'Apellido', 'Documento', 'Email', 'Tel√©fono', \n                   'Direcci√≥n', 'Cargo', 'Activo', 'Email Confirmado', 'Fecha Creaci√≥n']\n        \n        for emp in empleados:\n            data.append([\n                emp.id_empleados,\n                emp.usuario,\n                emp.nombre_empleado,\n                emp.apellido_empleado,\n                emp.numero_documento,\n                emp.email,\n                emp.telefono or '',\n                emp.direccion or '',\n                emp.cargo_establecido,\n                'S√≠' if emp.activo else 'No',\n                'S√≠' if emp.email_confirmado else 'No',\n                emp.fecha_creacion.strftime('%Y-%m-%d %H:%M') if emp.fecha_creacion else ''\n            ])\n        filename = f\"empleados_{datetime.now().strftime('%Y%m%d_%H%M%S')}\"\n        \n    elif tipo == 'tanques':\n        tanques = Tanque.query.all()\n        data = []\n        headers = ['ID', 'Tipo Combustible', 'Capacidad (gal)', 'Contenido (gal)', \n                   'Volumen (m¬≥)', 'Activo', 'Fecha Creaci√≥n']\n        \n        for tanque in tanques:\n            data.append([\n                tanque.id_tanques,\n                tanque.tipo_combustible,\n                tanque.capacidad,\n                tanque.contenido or 0,\n                tanque.volumen_m3,\n                'S√≠' if tanque.activo else 'No',\n                tanque.fecha_creacion.strftime('%Y-%m-%d') if tanque.fecha_creacion else ''\n            ])\n        filename = f\"tanques_{datetime.now().strftime('%Y%m%d_%H%M%S')}\"\n        \n    elif tipo == 'mediciones':\n        # Filtros opcionales\n        fecha_desde = request.args.get('fecha_desde')\n        fecha_hasta = request.args.get('fecha_hasta')\n        tanque_id = request.args.get('tanque_id')\n        \n        query = RegistroMedida.query\n        if fecha_desde:\n            query = query.filter(RegistroMedida.fecha_hora_registro >= fecha_desde)\n        if fecha_hasta:\n            query = query.filter(RegistroMedida.fecha_hora_registro <= fecha_hasta)\n        if tanque_id:\n            query = query.filter_by(id_tanques=int(tanque_id))\n        \n        mediciones = query.order_by(RegistroMedida.fecha_hora_registro.desc()).all()\n        \n        data = []\n        headers = ['ID', 'Fecha/Hora', 'Tanque', 'Tipo Combustible', 'Medida (cm)', \n                   'Galones', 'Tipo Medici√≥n', 'Empleado', 'Novedad']\n        \n        for med in mediciones:\n            data.append([\n                med.id_registro_medidas,\n                med.fecha_hora_registro.strftime('%Y-%m-%d %H:%M:%S') if med.fecha_hora_registro else '',\n                f\"Tanque {med.tanque.id_tanques}\" if med.tanque else 'N/A',\n                med.tanque.tipo_combustible if med.tanque else 'N/A',\n                med.medida_combustible or '',\n                med.galones or 0,\n                med.tipo_medida or 'rutinario',\n                med.empleado.nombre_empleado if med.empleado else 'N/A',\n                med.novedad or ''\n            ])\n        filename = f\"mediciones_{datetime.now().strftime('%Y%m%d_%H%M%S')}\"\n        \n    elif tipo == 'descargues':\n        # Filtros opcionales\n        fecha_desde = request.args.get('fecha_desde')\n        fecha_hasta = request.args.get('fecha_hasta')\n        \n        query = Descargue.query\n        if fecha_desde:\n            query = query.filter(Descargue.fecha >= fecha_desde)\n        if fecha_hasta:\n            query = query.filter(Descargue.fecha <= fecha_hasta)\n        \n        descargues = query.order_by(Descargue.fecha.desc()).all()\n        \n        data = []\n        headers = ['ID', 'Fecha', 'Tanque', 'Medida Inicial (gl)', 'Descargue (gl)', \n                   'Medida Final (gl)', 'Diferencia', 'Empleado', 'Kit Derrames', \n                   'Extintores', 'Observaciones']\n        \n        for desc in descargues:\n            data.append([\n                desc.idDescargue,\n                desc.fecha.strftime('%Y-%m-%d') if desc.fecha else '',\n                desc.tanque or '',\n                float(desc.medida_inicial_gl) if desc.medida_inicial_gl else 0,\n                float(desc.descargue_gl) if desc.descargue_gl else 0,\n                float(desc.medida_final_gl) if desc.medida_final_gl else 0,\n                float(desc.diferencia) if desc.diferencia else 0,\n                desc.empleado.nombre_empleado if desc.empleado else 'N/A',\n                desc.kit_derrames or 'no',\n                desc.extintores or 'no',\n                desc.observaciones1 or ''\n            ])\n        filename = f\"descargues_{datetime.now().strftime('%Y%m%d_%H%M%S')}\"\n    \n    else:\n        flash(\"Tipo de exportaci√≥n no v√°lido\", \"danger\")\n        return redirect(url_for('dashboard.index'))\n    \n    # Generar archivo seg√∫n formato\n    if formato == 'csv':\n        # Exportar como CSV\n        output = BytesIO()\n        df = pd.DataFrame(data, columns=headers)\n        df.to_csv(output, index=False, encoding='utf-8-sig')\n        output.seek(0)\n        \n        registrar_auditoria('EXPORT_CSV', tipo, None, None, {\n            'formato': 'csv',\n            'registros': len(data)\n        })\n        \n        return send_file(\n            output,\n            mimetype='text/csv',\n            as_attachment=True,\n            download_name=f\"{filename}.csv\"\n        )\n    \n    else:  # Excel\n        # Crear workbook de Excel con estilos\n        wb = openpyxl.Workbook()\n        ws = wb.active\n        ws.title = tipo.capitalize()\n        \n        # Estilo para encabezados\n        header_fill = PatternFill(start_color=\"E10000\", end_color=\"E10000\", fill_type=\"solid\")\n        header_font = Font(bold=True, color=\"FFFFFF\", size=12)\n        header_alignment = Alignment(horizontal=\"center\", vertical=\"center\")\n        \n        # Escribir encabezados\n        for col_num, header in enumerate(headers, 1):\n            cell = ws.cell(row=1, column=col_num)\n            cell.value = header\n            cell.fill = header_fill\n            cell.font = header_font\n            cell.alignment = header_alignment\n        \n        # Escribir datos\n        for row_num, row_data in enumerate(data, 2):\n            for col_num, value in enumerate(row_data, 1):\n                cell = ws.cell(row=row_num, column=col_num)\n                cell.value = value\n                cell.alignment = Alignment(horizontal=\"left\", vertical=\"center\")\n        \n        # Ajustar ancho de columnas\n        for column in ws.columns:\n            max_length = 0\n            column_letter = column[0].column_letter\n            for cell in column:\n                try:\n                    if len(str(cell.value)) > max_length:\n                        max_length = len(str(cell.value))\n                except:\n                    pass\n            adjusted_width = min(max_length + 2, 50)\n            ws.column_dimensions[column_letter].width = adjusted_width\n        \n        # Congelar primera fila\n        ws.freeze_panes = 'A2'\n        \n        # Guardar en BytesIO\n        output = BytesIO()\n        wb.save(output)\n        output.seek(0)\n        \n        registrar_auditoria('EXPORT_EXCEL', tipo, None, None, {\n            'formato': 'excel',\n            'registros': len(data)\n        })\n        \n        return send_file(\n            output,\n            mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\n            as_attachment=True,\n            download_name=f\"{filename}.xlsx\"\n        )\n\n# Agregar estas rutas al final de admin_bp en routes.py\n\n# ============= GESTI√É\"N COMPLETA DE TANQUES =============\n\n# ============= GESTI√ìN COMPLETA DE TANQUES =============\n\n@admin_bp.route(\"/tanques/crear\", methods=[\"GET\", \"POST\"])\n@login_required\n@admin_or_encargado_required\ndef crear_tanque():\n    \"\"\"Crear nuevo tanque\"\"\"\n    form = TanqueForm()\n    if form.validate_on_submit():\n        tanque = Tanque(\n            tipo_combustible=form.tipo_combustible.data,\n            capacidad=form.capacidad.data,\n            activo=form.activo.data,\n            altura_maxima_cm=calcular_altura_maxima(form.capacidad.data),\n            radio_cm=125.0\n        )\n        db.session.add(tanque)\n        db.session.commit()\n        \n        registrar_auditoria('CREATE', 'tanques', tanque.id_tanques, None, {\n            'tipo': form.tipo_combustible.data,\n            'capacidad': form.capacidad.data\n        })\n        \n        flash(\"Tanque creado exitosamente\", \"success\")\n        return redirect(url_for(\"dashboard.tanques\"))\n    \n    return render_template(\"admin/tanque_form.html\", form=form, titulo=\"Nuevo Tanque\", accion=\"crear\")\n\n\n@admin_bp.route(\"/tanques/<int:tanque_id>/editar\", methods=[\"GET\", \"POST\"])\n@login_required\n@admin_or_encargado_required\ndef editar_tanque(tanque_id):\n    \"\"\"Editar tanque existente\"\"\"\n    tanque = Tanque.query.get_or_404(tanque_id)\n    form = TanqueForm(obj=tanque)\n    \n    if form.validate_on_submit():\n        datos_anteriores = {\n            'tipo': tanque.tipo_combustible,\n            'capacidad': tanque.capacidad,\n            'activo': tanque.activo\n        }\n        \n        tanque.tipo_combustible = form.tipo_combustible.data\n        tanque.capacidad = form.capacidad.data\n        tanque.activo = form.activo.data\n        tanque.altura_maxima_cm = calcular_altura_maxima(form.capacidad.data)\n        \n        db.session.commit()\n        \n        registrar_auditoria('UPDATE', 'tanques', tanque_id, datos_anteriores, {\n            'tipo': tanque.tipo_combustible,\n            'capacidad': tanque.capacidad,\n            'activo': tanque.activo\n        })\n        \n        flash(\"Tanque actualizado exitosamente\", \"success\")\n        return redirect(url_for(\"dashboard.tanques\"))\n    \n    return render_template(\"admin/tanque_form.html\", form=form, titulo=\"Editar Tanque\", accion=\"editar\", tanque=tanque)\n\n\n@admin_bp.route(\"/tanques/<int:tanque_id>/toggle\", methods=[\"POST\"])\n@login_required\n@admin_or_encargado_required\ndef toggle_tanque(tanque_id):\n    \"\"\"Activar/Desactivar tanque\"\"\"\n    tanque = Tanque.query.get_or_404(tanque_id)\n    tanque.activo = not tanque.activo\n    db.session.commit()\n    \n    registrar_auditoria('UPDATE', 'tanques', tanque_id, \n                      {'activo': not tanque.activo}, {'activo': tanque.activo})\n    \n    estado = \"activado\" if tanque.activo else \"desactivado\"\n    flash(f\"Tanque {estado}\", \"success\")\n    return redirect(url_for(\"dashboard.tanques\"))\n\n\ndef calcular_altura_maxima(capacidad_galones):\n    \"\"\"Calcular altura m√°xima en cm basada en capacidad del tanque\"\"\"\n    # Radio est√°ndar en cm (ajustar seg√∫n tanques reales)\n    radio_cm = 125  # 2.5m de di√°metro\n    \n    # Volumen en cm¬≥ = capacidad en galones * 3785.411784\n    volumen_cm3 = capacidad_galones * 3785.411784\n    \n    # Altura = Volumen / (œÄ * r¬≤)\n    area_base = 3.14159 * (radio_cm ** 2)\n    altura_cm = volumen_cm3 / area_base\n    \n    return round(altura_cm, 2)\n\n# ============= CARGUE DE EMERGENCIA =============\n@medicion_bp.route(\"/cargue_emergencia\", methods=[\"GET\", \"POST\"])\n@login_required\n@islero_or_encargado_required\ndef cargue_emergencia():\n    from forms import CargueEmergenciaForm\n    form = CargueEmergenciaForm()\n    \n    tanques = Tanque.query.filter_by(activo=True).all()\n    form.tanque.choices = [(t.id_tanques, f\"{t.tipo_combustible} - Tanque {t.id_tanques}\") for t in tanques]\n    \n    if form.validate_on_submit():\n        tanque_seleccionado = Tanque.query.get(form.tanque.data)\n        \n        # Fix: Compute altura_maxima_cm if None\n        if tanque_seleccionado.altura_maxima_cm is None:\n            tanque_seleccionado.altura_maxima_cm = calcular_altura_maxima(tanque_seleccionado.capacidad)\n            db.session.commit()\n        \n        medida_anterior = float(form.medida_anterior.data.replace(',', '.'))\n        medida_posterior = float(form.medida_posterior.data.replace(',', '.'))\n        \n        # Fix: Only compare if altura_maxima_cm is not None\n        if tanque_seleccionado.altura_maxima_cm is not None:\n            if medida_anterior > tanque_seleccionado.altura_maxima_cm:\n                flash(\n                    f\"‚ùå Medida anterior ({medida_anterior} cm) supera altura m√°xima ({tanque_seleccionado.altura_maxima_cm} cm)\", \n                    \"danger\"\n                )\n                return render_template(\"medicion/cargue_emergencia.html\", form=form)\n            \n            if medida_posterior > tanque_seleccionado.altura_maxima_cm:\n                flash(\n                    f\"‚ùå Medida posterior ({medida_posterior} cm) supera altura m√°xima ({tanque_seleccionado.altura_maxima_cm} cm)\", \n                    \"danger\"\n                )\n                return render_template(\"medicion/cargue_emergencia.html\", form=form)\n        \n        # Rest of the code remains the same...\n    \n    # Cargar tanques en el selector\n    tanques = Tanque.query.filter_by(activo=True).all()\n    form.tanque.choices = [(t.id_tanques, f\"{t.tipo_combustible} - Tanque {t.id_tanques}\") for t in tanques]\n    \n    if form.validate_on_submit():\n        imagen_path = None\n        if form.imagen.data:\n            file = form.imagen.data\n            if allowed_file(file.filename):\n                filename = secure_filename(f\"{datetime.now().strftime('%Y%m%d%H%M%S')}_{file.filename}\")\n                filepath = os.path.join('static/uploads', filename)\n                os.makedirs('static/uploads', exist_ok=True)\n                file.save(filepath)\n                imagen_path = filename\n        \n        cargue = MedicionCargue(\n            id_empleados=current_user.id_empleados,\n            id_tanques=form.tanque.data,\n            medida_anterior=form.medida_anterior.data,\n            medida_posterior=form.medida_posterior.data,\n            formato_de_entrega=form.formato_entrega.data,\n            galones_totales=form.galones_totales.data,\n            fecha=datetime.now()\n        )\n        db.session.add(cargue)\n        db.session.commit()\n        \n        registrar_auditoria('CREATE', 'cargue_emergencia', cargue.id_medicion_cargue, None, {\n            'tanque': form.tanque.data,\n            'galones': form.galones_totales.data\n        })\n        \n        flash(\"Cargue de emergencia registrado exitosamente\", \"success\")\n        return redirect(url_for(\"medicion.historial_cargues\"))\n    \n    return render_template(\"medicion/cargue_emergencia.html\", form=form)\n\n\n@medicion_bp.route(\"/historial_cargues\")\n@login_required\n@islero_or_encargado_required\ndef historial_cargues():\n    \"\"\"Historial de cargues de emergencia\"\"\"\n    page = request.args.get(\"page\", 1, type=int)\n    cargues = MedicionCargue.query.order_by(\n        MedicionCargue.fecha.desc()\n    ).paginate(page=page, per_page=20, error_out=False)\n    \n    return render_template(\"medicion/historial_cargues.html\", cargues=cargues)\n\n@admin_bp.route(\"/update_alturas\")\n@login_required\n@admin_required\ndef update_alturas():\n    tanques = Tanque.query.all()\n    for t in tanques:\n        if t.altura_maxima_cm is None:\n            t.altura_maxima_cm = calcular_altura_maxima(t.capacidad)\n    db.session.commit()\n    flash(\"Alturas m√°ximas actualizadas para todos los tanques\", \"success\")\n    return redirect(url_for(\"dashboard.tanques\"))\n","path":null,"size_bytes":61690,"size_tokens":null},"generar_archivos_carga.py":{"content":"import pandas as pd\nfrom datetime import datetime\n\n# --- EMPLEADOS ---\nempleados = [\n    [\"Juan\", \"P√©rez\", \"12345678\", \"CC\", \"juan.perez@hayuelos.com\", \"3001234567\", \"Calle 1 #2-3\", \"Islero\", \"jperez\", \"Temp123!\", True, True, False],\n    [\"Mar√≠a\", \"G√≥mez\", \"87654321\", \"CC\", \"maria.gomez@hayuelos.com\", \"3109876543\", \"Carrera 4 #5-6\", \"Encargado\", \"mgomez\", \"Temp456!\", True, True, False],\n    [\"Carlos\", \"Rodr√≠guez\", \"11223344\", \"CC\", \"carlos.rodriguez@hayuelos.com\", \"3201122334\", \"Transversal 7 #8-9\", \"Islero\", \"crodriguez\", \"Temp789!\", True, True, False],\n    [\"Ana\", \"L√≥pez\", \"99887766\", \"CC\", \"ana.lopez@hayuelos.com\", \"3159988776\", \"Diagonal 10 #11-12\", \"Islero\", \"alopez\", \"Temp000!\", True, True, False],\n]\ncols_empleados = [\"nombre_empleado\",\"apellido_empleado\",\"numero_documento\",\"tipo_documento\",\"email\",\"telefono\",\"direccion\",\"cargo_establecido\",\"usuario\",\"contrasena\",\"temporal\",\"activo\",\"aceptado_terminos\"]\npd.DataFrame(empleados, columns=cols_empleados).to_csv(\"empleados_carga_masiva.csv\", index=False)\npd.DataFrame(empleados, columns=cols_empleados).to_excel(\"empleados_carga_masiva.xlsx\", index=False)\n\n# --- TANQUES ---\ntanques = [\n    [\"Diesel\", 8000, True],\n    [\"ACPM\", 10000, True],\n    [\"Extra\", 5000, True],\n    [\"Corriente\", 7000, False],\n]\ncols_tanques = [\"tipo_combustible\", \"capacidad\", \"activo\"]\npd.DataFrame(tanques, columns=cols_tanques).to_csv(\"tanques_carga_masiva.csv\", index=False)\npd.DataFrame(tanques, columns=cols_tanques).to_excel(\"tanques_carga_masiva.xlsx\", index=False)\n\n# --- MEDICIONES ---\nmediciones = [\n    [1, 45.5, 1200.00, \"rutinario\", \"Nivel estable\", \"2025-10-28 07:00:00\", 2],\n    [2, 60.0, 2800.50, \"cargue\", \"Cargue de 3000 gal\", \"2025-10-28 12:30:00\", 3],\n    [3, 30.2, 850.75, \"rutinario\", \"Fuga leve detectada\", \"2025-10-28 18:00:00\", 4],\n    [1, 44.8, 1180.00, \"rutinario\", \"Nivel bajo\", \"2025-10-29 07:00:00\", 2],\n]\ncols_mediciones = [\"tanque_id\",\"medida_combustible\",\"galones\",\"tipo_medida\",\"novedad\",\"fecha_hora_registro\",\"empleado_id\"]\npd.DataFrame(mediciones, columns=cols_mediciones).to_csv(\"mediciones_carga_masiva.csv\", index=False)\npd.DataFrame(mediciones, columns=cols_mediciones).to_excel(\"mediciones_carga_masiva.xlsx\", index=False)\n\nprint(\"Archivos generados: empleados, tanques, mediciones (.csv y .xlsx)\")","path":null,"size_bytes":2286,"size_tokens":null},"test_email.py":{"content":"# test_email.py\n# Script para probar la configuraci√≥n de env√≠o de emails\n# Ejecutar: python test_email.py\n\nimport os\nfrom flask_mail import Message\nfrom app_factory import create_app\nfrom extensions import mail\n\ndef test_email_config():\n    \"\"\"Verificar configuraci√≥n de email\"\"\"\n    print(\"=\" * 60)\n    print(\"üîç VERIFICANDO CONFIGURACI√ìN DE EMAIL\")\n    print(\"=\" * 60)\n    \n    app = create_app()\n    \n    with app.app_context():\n        print(f\"‚úÖ MAIL_SERVER: {app.config.get('MAIL_SERVER')}\")\n        print(f\"‚úÖ MAIL_PORT: {app.config.get('MAIL_PORT')}\")\n        print(f\"‚úÖ MAIL_USERNAME: {app.config.get('MAIL_USERNAME')}\")\n        print(f\"‚úÖ MAIL_USE_TLS: {app.config.get('MAIL_USE_TLS')}\")\n        print(f\"‚úÖ MAIL_DEFAULT_SENDER: {app.config.get('MAIL_DEFAULT_SENDER')}\")\n        \n        if not app.config.get('MAIL_USERNAME'):\n            print(\"\\n‚ùå ERROR: MAIL_USERNAME no est√° configurado\")\n            print(\"Configura las variables de entorno MAIL_USERNAME y MAIL_PASSWORD\")\n            return False\n        \n        return True\n\ndef send_test_email(recipient_email):\n    \"\"\"Enviar un email de prueba\"\"\"\n    print(\"\\n\" + \"=\" * 60)\n    print(f\"üìß ENVIANDO EMAIL DE PRUEBA A: {recipient_email}\")\n    print(\"=\" * 60)\n    \n    app = create_app()\n    \n    with app.app_context():\n        try:\n            msg = Message(\n                \"‚úÖ Prueba de Email - Sitex\",\n                recipients=[recipient_email]\n            )\n            \n            msg.body = \"\"\"\n            ¬°Hola!\n            \n            Este es un email de prueba del sistema Hayuelos.\n            \n            Si recibes este mensaje, significa que la configuraci√≥n de correo est√° funcionando correctamente.\n            \n            Detalles de la prueba:\n            - Sistema: Hayuelos - Estaci√≥n de Servicios\n            - Funcionalidad: Confirmaci√≥n de Email y Recuperaci√≥n de Contrase√±a\n            - Estado: ‚úÖ Operativo\n            \n            Saludos,\n            Sistema Hayuelos\n            \"\"\"\n            \n            msg.html = \"\"\"\n            <html>\n            <body style=\"font-family: Arial, sans-serif; line-height: 1.6; color: #333;\">\n                <div style=\"max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #ddd; border-radius: 10px;\">\n                    <h2 style=\"color: #E10000;\">‚úÖ Email de Prueba</h2>\n                    <p><strong>¬°Hola!</strong></p>\n                    <p>Este es un email de prueba del sistema Hayuelos.</p>\n                    \n                    <div style=\"background-color: #d4edda; padding: 15px; border-radius: 5px; margin: 20px 0; border-left: 5px solid #28a745;\">\n                        <p style=\"margin: 0;\"><strong>‚úÖ ¬°Configuraci√≥n Exitosa!</strong></p>\n                        <p style=\"margin: 5px 0 0 0;\">Si recibes este mensaje, el env√≠o de emails est√° funcionando correctamente.</p>\n                    </div>\n                    \n                    <h3 style=\"color: #E10000;\">Detalles de la Prueba:</h3>\n                    <ul>\n                        <li>Sistema: Hayuelos - Estaci√≥n de Servicios</li>\n                        <li>Funcionalidad: Confirmaci√≥n de Email y Recuperaci√≥n de Contrase√±a</li>\n                        <li>Estado: <span style=\"color: #28a745;\">‚úÖ Operativo</span></li>\n                    </ul>\n                    \n                    <hr style=\"margin: 30px 0; border: none; border-top: 1px solid #ddd;\">\n                    <p style=\"color: #999; font-size: 0.8em; text-align: center;\">\n                        Sistema Hayuelos - \"Y Tambi√©n vendemos combustible\"\n                    </p>\n                </div>\n            </body>\n            </html>\n            \"\"\"\n            \n            mail.send(msg)\n            print(\"‚úÖ Email enviado exitosamente!\")\n            print(f\"üì¨ Revisa la bandeja de entrada de: {recipient_email}\")\n            print(\"üí° Tambi√©n revisa la carpeta de spam/correo no deseado\")\n            return True\n            \n        except Exception as e:\n            print(f\"‚ùå ERROR al enviar email: {str(e)}\")\n            print(\"\\nüîß SOLUCIONES POSIBLES:\")\n            print(\"1. Verifica que MAIL_USERNAME y MAIL_PASSWORD est√©n configurados\")\n            print(\"2. Si usas Gmail, usa una 'Contrase√±a de Aplicaci√≥n'\")\n            print(\"3. Verifica que MAIL_SERVER y MAIL_PORT sean correctos\")\n            print(\"4. Aseg√∫rate de que no haya firewall bloqueando el puerto 587\")\n            return False\n\ndef test_confirmation_email_format():\n    \"\"\"Probar formato del email de confirmaci√≥n\"\"\"\n    print(\"\\n\" + \"=\" * 60)\n    print(\"üé® PROBANDO FORMATO DE EMAIL DE CONFIRMACI√ìN\")\n    print(\"=\" * 60)\n    \n    app = create_app()\n    \n    with app.app_context():\n        from models import Empleado\n        \n        # Crear empleado de prueba temporal\n        empleado_test = Empleado(\n            nombre_empleado=\"Usuario\",\n            apellido_empleado=\"Prueba\",\n            usuario=\"test_user\",\n            numero_documento=\"12345678\",\n            email=\"test@example.com\"\n        )\n        \n        token = empleado_test.generate_confirmation_token()\n        confirm_url = f\"http://localhost:5000/auth/confirm/{token}\"\n        \n        print(f\"‚úÖ URL de confirmaci√≥n generada:\")\n        print(f\"   {confirm_url}\")\n        print(f\"\\n‚úÖ Token generado: {token[:20]}...\")\n        print(f\"‚úÖ Expira en: 24 horas\")\n        \n        return True\n\ndef main():\n    print(\"\\n\" + \"=\" * 60)\n    print(\"üß™ SCRIPT DE PRUEBA - SISTEMA DE EMAILS HAYUELOS\")\n    print(\"=\" * 60)\n    \n    # 1. Verificar configuraci√≥n\n    if not test_email_config():\n        print(\"\\n‚ùå Configura las variables de entorno antes de continuar\")\n        return\n    \n    # 2. Solicitar email de destino\n    print(\"\\n\" + \"=\" * 60)\n    recipient = input(\"üìß Ingresa el email de prueba: \").strip()\n    \n    if not recipient or '@' not in recipient:\n        print(\"‚ùå Email inv√°lido\")\n        return\n    \n    # 3. Enviar email de prueba\n    if send_test_email(recipient):\n        print(\"\\n\" + \"=\" * 60)\n        print(\"‚úÖ PRUEBA COMPLETADA EXITOSAMENTE\")\n        print(\"=\" * 60)\n        print(\"\\nüìã PR√ìXIMOS PASOS:\")\n        print(\"1. Revisa tu bandeja de entrada\")\n        print(\"2. Si no ves el email, revisa spam/correo no deseado\")\n        print(\"3. Si funciona, puedes proceder con el registro de usuarios\")\n    else:\n        print(\"\\n\" + \"=\" * 60)\n        print(\"‚ùå PRUEBA FALLIDA\")\n        print(\"=\" * 60)\n        print(\"\\nüîß REVISA:\")\n        print(\"1. Variables de entorno (MAIL_USERNAME, MAIL_PASSWORD)\")\n        print(\"2. Conexi√≥n a internet\")\n        print(\"3. Credenciales del servidor SMTP\")\n    \n    # 4. Probar formato de confirmaci√≥n\n    test_confirmation_email_format()\n\nif __name__ == \"__main__\":\n    try:\n        main()\n    except KeyboardInterrupt:\n        print(\"\\n\\n‚ùå Prueba cancelada por el usuario\")\n    except Exception as e:\n        print(f\"\\n\\n‚ùå Error inesperado: {str(e)}\")","path":null,"size_bytes":6962,"size_tokens":null},"vercel.js":{"content":"{\n  \"builds\"; [\n    {\n      \"src\": \"main.py\",\n      \"use\": \"@vercel/python\"\n    }\n  ],\n  \"routes\"; [\n    {\n      \"src\": \"/(.*)\",\n      \"dest\": \"main.py\"\n    }\n  ]\n}","path":null,"size_bytes":164,"size_tokens":null},"create_admin.py":{"content":"# create_admin.py\n# Ejecutar desde el entorno del proyecto (donde est√© app_factory.py)\n# Ejemplo:\n# ADMIN_USERNAME=admin ADMIN_NUM_DOC=0000 ADMIN_EMAIL=admin@local ADMIN_PASSWORD=ChangeMe123! python create_admin.py\n\nimport os\nimport bcrypt\nfrom app_factory import create_app\nfrom extensions import db\nfrom models import Empleado\n\nADMIN_USERNAME = os.environ.get('ADMIN_USERNAME', 'admin')\nADMIN_NUM_DOC = os.environ.get('ADMIN_NUM_DOC', '0000000000')\nADMIN_EMAIL = os.environ.get('ADMIN_EMAIL', 'admin@local')\nADMIN_PASSWORD = os.environ.get('ADMIN_PASSWORD', 'ChangeMe123!')\n\napp = create_app()\n\nwith app.app_context():\n    # Busca por usuario/email/documento\n    admin = Empleado.query.filter(\n        (Empleado.usuario == ADMIN_USERNAME) |\n        (Empleado.email == ADMIN_EMAIL) |\n        (Empleado.numero_documento == ADMIN_NUM_DOC)\n    ).first()\n\n    hashed = bcrypt.hashpw(ADMIN_PASSWORD.encode('utf-8'), bcrypt.gensalt()).decode('utf-8')\n\n    if admin:\n        admin.usuario = ADMIN_USERNAME\n        admin.numero_documento = ADMIN_NUM_DOC\n        admin.email = ADMIN_EMAIL\n        admin.contrasena = hashed\n        admin.cargo_establecido = 'admin'\n        admin.temporal = False\n        admin.activo = True\n        admin.aceptado_terminos = True\n        print(\"Admin existente actualizado.\")\n    else:\n        admin = Empleado(\n            nombre_empleado='Admin',\n            apellido_empleado='Hayuelos',\n            numero_documento=ADMIN_NUM_DOC,\n            tipo_documento='CC',\n            email=ADMIN_EMAIL,\n            telefono='',\n            direccion='',\n            cargo_establecido='admin',\n            usuario=ADMIN_USERNAME,\n            contrasena=hashed,\n            temporal=False,\n            activo=True,\n            aceptado_terminos=True\n        )\n        db.session.add(admin)\n        print(\"Admin creado.\")\n\n    db.session.commit()\n    print(\"Operaci√≥n completada. Usuario admin:\", ADMIN_USERNAME)","path":null,"size_bytes":1932,"size_tokens":null},"fix_tanques.py":{"content":"# fix_tanques.py - Script para corregir datos de tanques\n# Ejecutar: python fix_tanques.py\n\nfrom app_factory import create_app\nfrom extensions import db\nfrom models import Tanque\n\ndef calcular_altura_maxima(capacidad_galones):\n    \"\"\"Calcular altura m√°xima en cm basada en capacidad del tanque\"\"\"\n    radio_cm = 125  # 2.5m de di√°metro\n    \n    # Volumen en cm¬≥ = capacidad en galones * 3785.411784\n    volumen_cm3 = capacidad_galones * 3785.411784\n    \n    # Altura = Volumen / (œÄ * r¬≤)\n    area_base = 3.14159 * (radio_cm ** 2)\n    altura_cm = volumen_cm3 / area_base\n    \n    return round(altura_cm, 2)\n\napp = create_app()\n\nwith app.app_context():\n    print(\"üîß Corrigiendo datos de tanques...\")\n    \n    tanques = Tanque.query.all()\n    \n    if not tanques:\n        print(\"‚ùå No hay tanques en la base de datos\")\n    else:\n        for tanque in tanques:\n            # Asegurar que altura_maxima_cm no sea None\n            if tanque.altura_maxima_cm is None or tanque.altura_maxima_cm == 0:\n                tanque.altura_maxima_cm = calcular_altura_maxima(tanque.capacidad)\n                print(f\"‚úÖ Tanque {tanque.id_tanques}: altura_maxima_cm = {tanque.altura_maxima_cm}\")\n            \n            # Asegurar que radio_cm no sea None\n            if tanque.radio_cm is None or tanque.radio_cm == 0:\n                tanque.radio_cm = 125.0\n                print(f\"‚úÖ Tanque {tanque.id_tanques}: radio_cm = {tanque.radio_cm}\")\n        \n        db.session.commit()\n        print(f\"\\n‚úÖ Se actualizaron {len(tanques)} tanques correctamente\")\n        \n        # Verificar\n        print(\"\\nüìä Estado de los tanques:\")\n        for tanque in tanques:\n            print(f\"  - Tanque {tanque.id_tanques} ({tanque.tipo_combustible}):\")\n            print(f\"    Capacidad: {tanque.capacidad} gal\")\n            print(f\"    Altura m√°x: {tanque.altura_maxima_cm} cm\")\n            print(f\"    Radio: {tanque.radio_cm} cm\")\n            print(f\"    Di√°metro: {tanque.diametro_m} m\")\n            print()\n\nprint(\"\\n‚úÖ Script completado\")","path":null,"size_bytes":2037,"size_tokens":null},"extensions.py":{"content":"# extensions.py - Extensiones centralizadas\nfrom flask_sqlalchemy import SQLAlchemy\nfrom flask_login import LoginManager\nfrom flask_migrate import Migrate\nfrom flask_wtf.csrf import CSRFProtect\nfrom flask_mail import Mail\nfrom sqlalchemy.orm import DeclarativeBase\n\nclass Base(DeclarativeBase):\n    pass\n\n# Inicializar extensiones\ndb = SQLAlchemy(model_class=Base)\nlogin_manager = LoginManager()\nmigrate = Migrate()\ncsrf = CSRFProtect()\nmail = Mail()\n","path":null,"size_bytes":451,"size_tokens":null},"models.py":{"content":"# models.py - ACTUALIZADO CON CONFIRMACI√ìN DE EMAIL\nfrom flask_login import UserMixin\nfrom datetime import datetime, timedelta\nimport secrets\nfrom extensions import db\nfrom itsdangerous import URLSafeTimedSerializer\nfrom flask import current_app\n\nclass Empleado(db.Model, UserMixin):\n    __tablename__ = 'empleado'\n    id_empleados = db.Column(db.Integer, primary_key=True)\n    nombre_empleado = db.Column(db.String(30), nullable=False)\n    apellido_empleado = db.Column(db.String(30), nullable=False)\n    numero_documento = db.Column(db.String(20), unique=True, nullable=False)\n    tipo_documento = db.Column(db.String(20), nullable=False)\n    email = db.Column(db.String(45), unique=True, nullable=False)\n    telefono = db.Column(db.String(15))\n    direccion = db.Column(db.String(45))\n    cargo_establecido = db.Column(db.String(45))\n    usuario = db.Column(db.String(15), unique=True, nullable=False)\n    contrasena = db.Column(db.String(255), nullable=False)\n    temporal = db.Column(db.Boolean, default=True)\n    activo = db.Column(db.Boolean, default=True)\n    \n    # NUEVOS CAMPOS PARA CONFIRMACI√ìN DE EMAIL\n    email_confirmado = db.Column(db.Boolean, default=False)\n    token_confirmacion = db.Column(db.String(100))\n    token_confirmacion_expiry = db.Column(db.DateTime)\n    \n    # Recuperaci√≥n de contrase√±a\n    reset_token = db.Column(db.String(100))\n    reset_token_expiry = db.Column(db.DateTime)\n    \n    aceptado_terminos = db.Column(db.Boolean, default=False)\n    fecha_creacion = db.Column(db.DateTime, default=datetime.utcnow)\n\n    # Relaciones\n    descargues = db.relationship(\"Descargue\", back_populates=\"empleado\", lazy=True)\n    mediciones_cargue = db.relationship(\"MedicionCargue\", back_populates=\"empleado\", lazy=True)\n    registro_medidas = db.relationship(\"RegistroMedida\", back_populates=\"empleado\", lazy=True)\n    pedidos_combustible = db.relationship(\"PedidoCombustible\", back_populates=\"empleado\", lazy=True)\n    documentos = db.relationship(\"Documento\", back_populates=\"empleado\", lazy=True)\n    sesiones_activas = db.relationship(\"SesionActiva\", back_populates=\"empleado\", lazy=True)\n    acciones_auditoria = db.relationship(\"Auditoria\", back_populates=\"empleado\", lazy=True)\n\n    def get_id(self):\n        return str(self.id_empleados)\n\n    @property\n    def idEmpleados(self):\n        return self.id_empleados\n\n    @property\n    def rol(self):\n        return self.cargo_establecido\n\n    @property\n    def confirmado(self):\n        return self.email_confirmado\n\n    @property\n    def is_active(self):\n        return self.activo and self.email_confirmado\n\n    def __repr__(self):\n        return f'<Empleado {self.nombre_empleado} {self.apellido_empleado}>'\n\n    def check_password(self, raw_password):\n        import bcrypt\n        if not getattr(self, 'contrasena', None):\n            return False\n        return bcrypt.checkpw(raw_password.encode('utf-8'), self.contrasena.encode('utf-8'))\n\n    @property\n    def is_locked(self):\n        return not self.activo\n\n    # NUEVO: Generar token de confirmaci√≥n de email\n    def generate_confirmation_token(self, hours_valid=24):\n        token = secrets.token_urlsafe(48)\n        self.token_confirmacion = token\n        self.token_confirmacion_expiry = datetime.utcnow() + timedelta(hours=hours_valid)\n        return token\n\n    # NUEVO: Verificar token de confirmaci√≥n\n    def verify_confirmation_token(self, token):\n        if not self.token_confirmacion or self.token_confirmacion != token:\n            return False\n        if not getattr(self, 'token_confirmacion_expiry', None):\n            return False\n        return datetime.utcnow() < self.token_confirmacion_expiry\n\n\n    # NUEVO: Confirmar email\n    def confirmar_email(self):\n        self.email_confirmado = True\n        self.token_confirmacion = None\n        self.token_confirmacion_expiry = None\n\n    def generate_reset_token(self):\n        \"\"\"Generar token de recuperaci√≥n de contrase√±a\"\"\"\n        self.reset_token = secrets.token_urlsafe(32)\n        self.reset_token_expiry = datetime.utcnow() + timedelta(hours=1)\n        return self.reset_token\n\n    def verify_reset_token(self, token):\n        \"\"\"Verificar token de recuperaci√≥n\"\"\"\n        if self.reset_token == token and self.reset_token_expiry > datetime.utcnow():\n            return True\n        return False\n\n\nclass SesionActiva(db.Model):\n    \"\"\"Tabla para rastrear sesiones activas\"\"\"\n    __tablename__ = 'sesiones_activas'\n    id_sesion = db.Column(db.Integer, primary_key=True)\n    id_empleados = db.Column(db.Integer, db.ForeignKey('empleado.id_empleados'), nullable=False)\n    session_id = db.Column(db.String(100), unique=True, nullable=False)\n    fecha_inicio = db.Column(db.DateTime, default=datetime.utcnow)\n    fecha_actividad = db.Column(db.DateTime, default=datetime.utcnow)\n    ip_address = db.Column(db.String(45))\n    user_agent = db.Column(db.String(255))\n    activa = db.Column(db.Boolean, default=True)\n    \n    empleado = db.relationship(\"Empleado\", back_populates=\"sesiones_activas\")\n\n\nclass Auditoria(db.Model):\n    \"\"\"Tabla de auditor√≠a para rastrear cambios\"\"\"\n    __tablename__ = 'auditoria'\n    id_auditoria = db.Column(db.Integer, primary_key=True)\n    id_empleados = db.Column(db.Integer, db.ForeignKey('empleado.id_empleados'))\n    accion = db.Column(db.String(50))\n    tabla = db.Column(db.String(50))\n    registro_id = db.Column(db.Integer)\n    datos_anteriores = db.Column(db.Text)\n    datos_nuevos = db.Column(db.Text)\n    fecha_hora = db.Column(db.DateTime, default=datetime.utcnow)\n    ip_address = db.Column(db.String(45))\n    \n    empleado = db.relationship(\"Empleado\", back_populates=\"acciones_auditoria\")\n\n\n# models.py - SECCI√ìN DE TANQUE CORREGIDA\n\nclass Tanque(db.Model):\n    __tablename__ = 'tanques'\n    id_tanques = db.Column(db.Integer, primary_key=True)\n    tipo_combustible = db.Column(db.String(45))\n    capacidad = db.Column(db.Integer)\n    activo = db.Column(db.Boolean, default=True)\n    fecha_creacion = db.Column(db.DateTime, default=datetime.utcnow)\n    \n    # Altura m√°xima permitida en cm\n    altura_maxima_cm = db.Column(db.Float, default=0.0)\n    \n    # Radio del tanque en cm\n    radio_cm = db.Column(db.Float, default=125.0)\n\n    mediciones_cargue = db.relationship(\"MedicionCargue\", back_populates=\"tanque\", lazy=True)\n    registro_medidas = db.relationship(\"RegistroMedida\", back_populates=\"tanque\", lazy=True)\n    ventas = db.relationship(\"Venta\", back_populates=\"tanque\", lazy=True)\n\n    @property\n    def idTanques(self):\n        return self.id_tanques\n\n    @property\n    def capacidad_gal(self):\n        return self.capacidad or 0\n\n    @property\n    def contenido(self):\n        \"\"\"Obtener contenido actual del tanque en galones\"\"\"\n        ultima_medicion = RegistroMedida.query.filter_by(\n            id_tanques=self.id_tanques\n        ).order_by(RegistroMedida.fecha_hora_registro.desc()).first()\n        \n        if ultima_medicion and ultima_medicion.galones:\n            return float(ultima_medicion.galones)\n        return 0.0\n\n    @property\n    def altura_actual_cm(self):\n        \"\"\"Obtener altura actual en cm basada en √∫ltima medici√≥n\"\"\"\n        ultima_medicion = RegistroMedida.query.filter_by(\n            id_tanques=self.id_tanques\n        ).order_by(RegistroMedida.fecha_hora_registro.desc()).first()\n        \n        if not ultima_medicion or not ultima_medicion.medida_combustible:\n            return 0.0\n        \n        try:\n            return float(ultima_medicion.medida_combustible)\n        except (ValueError, TypeError):\n            return 0.0\n\n    @property\n    def porcentaje_llenado(self):\n        \"\"\"Porcentaje de llenado del tanque\"\"\"\n        capacidad = self.capacidad or 0\n        contenido = self.contenido or 0\n        \n        if capacidad > 0:\n            return (contenido / capacidad) * 100\n        return 0.0\n    \n    @property\n    def volumen_m3(self):\n        \"\"\"Volumen en metros c√∫bicos\"\"\"\n        capacidad = self.capacidad or 0\n        return round(capacidad * 3.78541 / 1000, 2)\n\n    @property\n    def diametro_m(self):\n        \"\"\"Di√°metro en metros\"\"\"\n        radio_cm = self.radio_cm or 125.0\n        return (radio_cm * 2) / 100\n\n    @property\n    def altura_m(self):\n        \"\"\"Altura m√°xima en metros\"\"\"\n        altura_maxima = self.altura_maxima_cm or 0.0\n        return altura_maxima / 100\n\n    def validar_medicion(self, medida_cm):\n        \"\"\"Validar que una medici√≥n no exceda la altura m√°xima\"\"\"\n        altura_max = self.altura_maxima_cm or 0\n        if medida_cm > altura_max:\n            return False, f\"Medida excede altura m√°xima del tanque ({altura_max} cm)\"\n        return True, \"OK\"\n\n    def cm_a_galones(self, altura_cm):\n        \"\"\"Convertir altura en cm a galones para este tanque espec√≠fico\"\"\"\n        radio = self.radio_cm or 125.0\n        if radio <= 0:\n            return 0\n        \n        # Volumen = œÄ * r¬≤ * h\n        area_base = 3.14159 * (radio ** 2)\n        volumen_cm3 = area_base * altura_cm\n        \n        # 1 gal√≥n = 3785.411784 cm¬≥\n        galones = volumen_cm3 / 3785.411784\n        \n        return round(galones, 2)\n\n    def __repr__(self):\n        return f'<Tanque {self.tipo_combustible} - {self.capacidad} gal>'\n\n\nclass Descargue(db.Model):\n    __tablename__ = 'descargues'\n    idDescargue = db.Column(db.Integer, primary_key=True)\n    id_empleados = db.Column(db.Integer, db.ForeignKey('empleado.id_empleados'), nullable=False)\n    empleado = db.relationship(\"Empleado\", back_populates=\"descargues\")\n\n    medida_inicial_cm = db.Column(db.Numeric(10, 2))\n    medida_inicial_gl = db.Column(db.Numeric(10, 2))\n    descargue_cm = db.Column(db.Numeric(10, 2))\n    descargue_gl = db.Column(db.Numeric(10, 2))\n    medida_final_cm = db.Column(db.Numeric(10, 2))\n    medida_final_gl = db.Column(db.Numeric(10, 2))\n    diferencia = db.Column(db.Numeric(10, 2))\n    tanque = db.Column(db.String(50))\n    observaciones1 = db.Column(db.String(255))\n    observaciones2 = db.Column(db.String(255))\n    kit_derrames = db.Column(db.String(5))\n    extintores = db.Column(db.String(5))\n    conos = db.Column(db.String(5))\n    boquillas = db.Column(db.String(5))\n    botas = db.Column(db.String(5))\n    gafas = db.Column(db.String(5))\n    tapaoidos = db.Column(db.String(5))\n    guantes = db.Column(db.String(5))\n    brillante = db.Column(db.String(5))\n    traslucido = db.Column(db.String(5))\n    claro = db.Column(db.String(5))\n    solidos = db.Column(db.String(5))\n    separacion = db.Column(db.String(50))\n    fecha = db.Column(db.Date)\n    imagen_path = db.Column(db.String(255))\n\n    def __repr__(self):\n        return f'<Descargue {self.tanque} - {self.fecha}>'\n\n\nclass MedicionCargue(db.Model):\n    __tablename__ = 'medicion_cargue'\n    id_medicion_cargue = db.Column(db.Integer, primary_key=True)\n    medida_anterior = db.Column(db.String(45))\n    medida_posterior = db.Column(db.String(45))\n    formato_de_entrega = db.Column(db.String(45))\n    galones_totales = db.Column(db.String(45))\n    id_tanques = db.Column(db.Integer, db.ForeignKey('tanques.id_tanques'))\n    id_empleados = db.Column(db.Integer, db.ForeignKey('empleado.id_empleados'))\n    fecha = db.Column(db.DateTime, default=datetime.utcnow)\n\n    empleado = db.relationship(\"Empleado\", back_populates=\"mediciones_cargue\")\n    tanque = db.relationship(\"Tanque\", back_populates=\"mediciones_cargue\")\n\n    @property\n    def idMedicion_cargue(self):\n        return self.id_medicion_cargue\n\n    @property\n    def idEmpleados(self):\n        return self.id_empleados\n\n    @property\n    def idTanques(self):\n        return self.id_tanques\n\n    def __repr__(self):\n        return f'<MedicionCargue {self.galones_totales} - {self.fecha}>'\n\n\nclass RegistroMedida(db.Model):\n    __tablename__ = 'registro_medidas'\n    id_registro_medidas = db.Column(db.Integer, primary_key=True)\n    medida_combustible = db.Column(db.String(45))\n    id_empleados = db.Column(db.Integer, db.ForeignKey('empleado.id_empleados'))\n    fecha_hora_registro = db.Column(db.DateTime)\n    galones = db.Column(db.Integer)\n    id_tanques = db.Column(db.Integer, db.ForeignKey('tanques.id_tanques'))\n    novedad = db.Column(db.String(255))\n    tipo_medida = db.Column(db.String(30), default='rutinario')\n    imagen_path = db.Column(db.String(255))\n\n    empleado = db.relationship(\"Empleado\", back_populates=\"registro_medidas\")\n    tanque = db.relationship(\"Tanque\", back_populates=\"registro_medidas\")\n\n    @property\n    def idRegistro_medidas(self):\n        return self.id_registro_medidas\n\n    @property\n    def idEmpleados(self):\n        return self.id_empleados\n\n    @property\n    def idTanques(self):\n        return self.id_tanques\n\n    def __repr__(self):\n        return f'<RegistroMedida {self.galones} gal - {self.fecha_hora_registro}>'\n\n\nclass PedidoCombustible(db.Model):\n    __tablename__ = 'pedido_combustible'\n    idPedido_Combustible = db.Column(db.Integer, primary_key=True)\n    galones_acpm = db.Column(db.String(45))\n    galones_corriente = db.Column(db.String(45))\n    galones_extra = db.Column(db.String(45))\n    total_galones = db.Column(db.String(45))\n    id_empleados = db.Column(db.Integer, db.ForeignKey('empleado.id_empleados'))\n\n    empleado = db.relationship(\"Empleado\", back_populates=\"pedidos_combustible\")\n\n    def __repr__(self):\n        return f'<PedidoCombustible {self.total_galones} gal>'\n\n\nclass Documento(db.Model):\n    __tablename__ = 'documento'\n    idDocumento = db.Column(db.Integer, primary_key=True)\n    nombre_documento = db.Column(db.String(100))\n    fecha_informe = db.Column(db.Date)\n    tipo_documento_informe = db.Column(db.String(45))\n    tipo_medicion = db.Column(db.String(45))\n    fecha_descargue = db.Column(db.Date)\n    id_empleado = db.Column(db.String(45))\n    id_empleados = db.Column(db.Integer, db.ForeignKey('empleado.id_empleados'))\n    revision_vehiculo = db.Column(db.String(3))\n    revision_conductor = db.Column(db.String(3))\n    medida_inicial = db.Column(db.String(45))\n    cantidad_descargue = db.Column(db.String(45))\n    medida_final = db.Column(db.String(45))\n    diferencias = db.Column(db.String(45))\n    id_registro_medidas = db.Column(db.Integer, db.ForeignKey('registro_medidas.id_registro_medidas'))\n\n    empleado = db.relationship(\"Empleado\", back_populates=\"documentos\")\n    adjuntos = db.relationship(\"DocumentoAdjunto\", backref=\"documento\", lazy=True)\n    historial = db.relationship(\"DocumentoHistorial\", backref=\"documento\", lazy=True)\n\n    def __repr__(self):\n        return f'<Documento {self.nombre_documento}>'\n\n\nclass DocumentoAdjunto(db.Model):\n    __tablename__ = 'documento_adjunto'\n    idAdjunto = db.Column(db.Integer, primary_key=True)\n    idDocumento = db.Column(db.Integer, db.ForeignKey('documento.idDocumento'))\n    nombre_archivo = db.Column(db.String(100))\n    url_archivo = db.Column(db.Text)\n    fecha_subida = db.Column(db.DateTime)\n\n\nclass DocumentoHistorial(db.Model):\n    __tablename__ = 'documento_historial'\n    idHistorial = db.Column(db.Integer, primary_key=True)\n    idDocumento = db.Column(db.Integer, db.ForeignKey('documento.idDocumento'))\n    fecha_evento = db.Column(db.DateTime)\n    descripcion_evento = db.Column(db.String(255))\n    usuario_responsable = db.Column(db.String(45))\n\n\nclass DocumentoTipo(db.Model):\n    __tablename__ = 'documento_tipo'\n    idTipoDocumento = db.Column(db.Integer, primary_key=True)\n    nombre_tipo = db.Column(db.String(45))\n\n\nclass Venta(db.Model):\n    __tablename__ = 'ventas'\n    idVenta = db.Column(db.Integer, primary_key=True)\n    id_tanques = db.Column(db.Integer, db.ForeignKey('tanques.id_tanques'))\n    cantidad_galones = db.Column(db.Integer)\n    fecha = db.Column(db.DateTime, default=datetime.utcnow)\n\n    tanque = db.relationship(\"Tanque\", back_populates=\"ventas\")\n\n    def __repr__(self):\n        return f'<Venta {self.cantidad_galones} gal - {self.fecha}>'\n\n\nclass InicioSesion(db.Model):\n    __tablename__ = 'inicio_de_sesion'\n    userNumDoc = db.Column(db.String(20), primary_key=True)\n    password = db.Column(db.String(255))\n    temporal = db.Column(db.Boolean, default=False)\n\n\nclass InicioSesionEmpleado(db.Model):\n    __tablename__ = 'inicio_de_sesion_has_empleado'\n    id_empleados = db.Column(db.Integer, db.ForeignKey('empleado.id_empleados'), primary_key=True)\n    userNumDoc = db.Column(db.String(20), db.ForeignKey('inicio_de_sesion.userNumDoc'), primary_key=True)\n\n\nclass RegistroMedidaMedicionCargue(db.Model):\n    __tablename__ = 'registro_medidas_has_medicion_cargue'\n    id_registro_medidas = db.Column(db.Integer, db.ForeignKey('registro_medidas.id_registro_medidas'), primary_key=True)\n    id_medicion_cargue = db.Column(db.Integer, db.ForeignKey('medicion_cargue.id_medicion_cargue'), primary_key=True)\n","path":null,"size_bytes":16681,"size_tokens":null},"seed_db.py":{"content":"# seed_db.py - Crear tablas e insertar tanques iniciales\n# Uso: python seed_db.py\n\nfrom app_factory import create_app\nfrom extensions import db\nfrom models import Tanque\n\napp = create_app()\n\nwith app.app_context():\n    # Si prefieres usar migraciones, evita create_all en producci√≥n.\n    db.create_all()\n\n    if db.session.query(Tanque).count() == 0:\n        tanque1 = Tanque(tipo_combustible='Diesel', capacidad=6000, activo=True)\n        tanque2 = Tanque(tipo_combustible='Diesel', capacidad=12000, activo=True)\n        tanque3 = Tanque(tipo_combustible='ACPM', capacidad=12000, activo=True)\n        tanque4 = Tanque(tipo_combustible='Extra', capacidad=6000, activo=True)\n\n        db.session.add_all([tanque1, tanque2, tanque3, tanque4])\n        db.session.commit()\n        print(\"‚úì Tanques creados\")\n    else:\n        print(\"Tanques ya existen, no se a√±adi√≥ nada.\")","path":null,"size_bytes":873,"size_tokens":null},"static/css/style.css":{"content":"/* ========================================\n   LOGIN Y REGISTER - FORMAS ORG√É¬ÅNICAS (BLOBS) ROJO SUAVE CON BLOBS BLANCOS ANIMADOS\n   ======================================== */\nbody.auth-page {\n    background: #FF4444 !important;\n    min-height: 100vh;\n    display: block;\n    position: relative;\n    overflow-y: auto;\n    overflow-x: hidden;\n}\n\n/* Blob blanco grande superior derecha */\nbody.auth-page::before {\n    content: '';\n    position: absolute;\n    top: -15%;\n    right: -8%;\n    width: 55%;\n    height: 65%;\n    background: #FFFFFF;\n    border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;\n    transform: rotate(-15deg);\n    animation: floatShape1 20s ease-in-out infinite;\n    z-index: 0;\n    box-shadow: 0 25px 70px rgba(255, 255, 255, 0.3);\n}\n\n/* Blob blanco grande inferior izquierda */\nbody.auth-page::after {\n    content: '';\n    position: absolute;\n    bottom: -12%;\n    left: -8%;\n    width: 50%;\n    height: 60%;\n    background: #FFFFFF;\n    border-radius: 70% 30% 30% 70% / 70% 70% 30% 30%;\n    transform: rotate(15deg);\n    animation: floatShape2 25s ease-in-out infinite;\n    z-index: 0;\n    box-shadow: 0 25px 70px rgba(255, 255, 255, 0.3);\n}\n\n/* Animaciones suaves de las formas */\n@keyframes floatShape1 {\n    0%, 100% { \n        transform: rotate(-15deg) translateY(0px) translateX(0px) scale(1);\n        border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;\n    }\n    33% {\n        transform: rotate(-18deg) translateY(-25px) translateX(15px) scale(1.05);\n        border-radius: 40% 60% 65% 35% / 35% 45% 55% 65%;\n    }\n    66% { \n        transform: rotate(-12deg) translateY(-15px) translateX(-10px) scale(0.98);\n        border-radius: 50% 50% 60% 40% / 40% 50% 50% 60%;\n    }\n}\n\n@keyframes floatShape2 {\n    0%, 100% { \n        transform: rotate(15deg) translateY(0px) translateX(0px) scale(1);\n        border-radius: 70% 30% 30% 70% / 70% 70% 30% 30%;\n    }\n    33% {\n        transform: rotate(18deg) translateY(20px) translateX(-15px) scale(1.05);\n        border-radius: 65% 35% 40% 60% / 65% 55% 45% 35%;\n    }\n    66% { \n        transform: rotate(12deg) translateY(35px) translateX(10px) scale(0.98);\n        border-radius: 40% 60% 50% 50% / 60% 50% 50% 40%;\n    }\n}/* \n * Hayuelos Estaci√É¬≥n de Servicios - Estilos Corporativos con Degradados Vibrantes\n * Colores: Negro #000000, Rojo #E10000, Azul #00E1E1, Verde #00E100\n * Sistema de diferenciaci√É¬≥n por roles: Admin (Rojo), Encargado (Azul), Islero (Verde)\n */\n\n/* Importar tipograf√É¬≠a corporativa */\n@import url('https://fonts.googleapis.com/css2?family=Century+Gothic:wght@400;700&display=swap');\n\n/* ========================================\n   VARIABLES DE COLORES CORPORATIVOS\n   ======================================== */\n:root {\n    --hayuelos-negro: #000000;\n    --hayuelos-rojo: #E10000;\n    --hayuelos-azul: #00E1E1;\n    --hayuelos-verde: #00E100;\n    --hayuelos-blanco: #FFFFFF;\n    \n    /* Degradados vibrantes corporativos */\n    --gradient-primary: linear-gradient(135deg, #E10000 0%, #FF3030 50%, #E10000 100%);\n    --gradient-secondary: linear-gradient(135deg, #00E1E1 0%, #30F0F0 50%, #00E1E1 100%);\n    --gradient-success: linear-gradient(135deg, #00E100 0%, #30F030 50%, #00E100 100%);\n    --gradient-dark: linear-gradient(135deg, #000000 0%, #1a1a1a 50%, #000000 100%);\n    \n    /* Degradado hero multicolor vibrante */\n    --gradient-hero: linear-gradient(135deg, \n        #E10000 0%, \n        #FF0040 20%,\n        #00E1E1 50%,\n        #00FFE1 70%,\n        #00E100 100%);\n    \n    /* Degradados para cada rol */\n    --gradient-admin: linear-gradient(135deg, \n        #E10000 0%, \n        #FF2020 25%,\n        #FF0000 50%,\n        #E10000 75%,\n        #C20000 100%);\n    \n    --gradient-encargado: linear-gradient(135deg, \n        #00E1E1 0%, \n        #20F0F0 25%,\n        #00FFFF 50%,\n        #00E1E1 75%,\n        #00C2C2 100%);\n    \n    --gradient-islero: linear-gradient(135deg, \n        #00E100 0%, \n        #20F020 25%,\n        #00FF00 50%,\n        #00E100 75%,\n        #00C200 100%);\n}\n\n/* ========================================\n   TIPOGRAF√É¬çA CORPORATIVA\n   ======================================== */\nbody {\n    font-family: 'Century Gothic', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n    font-weight: 400;\n    background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);\n    min-height: 100vh;\n}\n\nh1, h2, h3, h4, h5, h6, .navbar-brand {\n    font-weight: 700;\n    font-style: italic;\n}\n\n/* ========================================\n   NAVBAR BASE CON DEGRADADO MULTICOLOR\n   ======================================== */\n.navbar-dark.bg-primary {\n    background: var(--gradient-dark) !important;\n    border-bottom: 5px solid transparent;\n    border-image: var(--gradient-hero);\n    border-image-slice: 1;\n    box-shadow: 0 5px 25px rgba(0, 0, 0, 0.4);\n    position: relative;\n}\n\n.navbar-dark.bg-primary::after {\n    content: '';\n    position: absolute;\n    bottom: -5px;\n    left: 0;\n    right: 0;\n    height: 5px;\n    background: var(--gradient-hero);\n    animation: borderFlow 8s linear infinite;\n    background-size: 200% 100%;\n}\n\n@keyframes borderFlow {\n    0% { background-position: 0% 50%; }\n    100% { background-position: 200% 50%; }\n}\n\n/* ========================================\n   DIFERENCIACI√É‚ÄúN POR ROL - NAVBAR\n   ======================================== */\n\n/* ADMIN - Navbar Rojo */\nbody.role-admin .navbar-dark.bg-primary {\n    background: var(--gradient-admin) !important;\n    background-size: 200% 200%;\n    animation: gradientPulse 6s ease infinite;\n}\n\nbody.role-admin .navbar-dark.bg-primary::after {\n    background: linear-gradient(90deg, \n        #E10000 0%, \n        #FF4040 25%, \n        #E10000 50%, \n        #FF4040 75%, \n        #E10000 100%);\n    background-size: 200% 100%;\n}\n\n/* ENCARGADO - Navbar Azul */\nbody.role-encargado .navbar-dark.bg-primary {\n    background: var(--gradient-encargado) !important;\n    background-size: 200% 200%;\n    animation: gradientPulse 6s ease infinite;\n}\n\nbody.role-encargado .navbar-dark.bg-primary::after {\n    background: linear-gradient(90deg, \n        #00E1E1 0%, \n        #40F0F0 25%, \n        #00E1E1 50%, \n        #40F0F0 75%, \n        #00E1E1 100%);\n    background-size: 200% 100%;\n}\n\n/* ISLERO - Navbar Verde */\nbody.role-islero .navbar-dark.bg-primary {\n    background: var(--gradient-islero) !important;\n    background-size: 200% 200%;\n    animation: gradientPulse 6s ease infinite;\n}\n\nbody.role-islero .navbar-dark.bg-primary::after {\n    background: linear-gradient(90deg, \n        #00E100 0%, \n        #40F040 25%, \n        #00E100 50%, \n        #40F040 75%, \n        #00E100 100%);\n    background-size: 200% 100%;\n}\n\n@keyframes gradientPulse {\n    0%, 100% { background-position: 0% 50%; }\n    50% { background-position: 100% 50%; }\n}\n\n/* ========================================\n   ELEMENTOS DEL NAVBAR\n   ======================================== */\n.navbar-brand {\n    color: var(--hayuelos-blanco) !important;\n    font-weight: bold;\n    font-size: 1.5rem;\n    text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.6);\n    transition: all 0.3s ease;\n}\n\n.navbar-brand:hover {\n    transform: scale(1.08);\n    text-shadow: 0 0 20px rgba(255, 255, 255, 0.8);\n}\n\n.nav-link {\n    color: var(--hayuelos-blanco) !important;\n    transition: all 0.3s ease;\n    position: relative;\n    padding: 0.5rem 1rem !important;\n    font-weight: 500;\n}\n\n.nav-link:hover {\n    transform: translateY(-2px);\n    text-shadow: 0 0 10px rgba(255, 255, 255, 0.6);\n}\n\n.nav-link::after {\n    content: '';\n    position: absolute;\n    bottom: 0;\n    left: 50%;\n    width: 0;\n    height: 3px;\n    background: var(--gradient-hero);\n    transition: all 0.3s ease;\n    transform: translateX(-50%);\n    border-radius: 2px;\n}\n\n.nav-link:hover::after {\n    width: 80%;\n}\n\n.dropdown-menu {\n    background: var(--gradient-dark);\n    border: 2px solid var(--hayuelos-rojo);\n    border-radius: 15px;\n    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);\n    overflow: hidden;\n}\n\n.dropdown-item {\n    color: var(--hayuelos-blanco) !important;\n    transition: all 0.3s ease;\n    border-radius: 10px;\n    margin: 5px;\n    font-weight: 500;\n}\n\n.dropdown-item:hover {\n    background: var(--gradient-primary) !important;\n    transform: translateX(8px);\n}\n\n/* ========================================\n   BOTONES CON DEGRADADOS VIBRANTES\n   ======================================== */\n.btn {\n    border-radius: 30px;\n    font-weight: 600;\n    padding: 12px 30px;\n    transition: all 0.4s ease;\n    border: none;\n    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);\n    position: relative;\n    overflow: hidden;\n}\n\n.btn::before {\n    content: '';\n    position: absolute;\n    top: 50%;\n    left: 50%;\n    width: 0;\n    height: 0;\n    border-radius: 50%;\n    background: rgba(255, 255, 255, 0.4);\n    transform: translate(-50%, -50%);\n    transition: width 0.6s, height 0.6s;\n}\n\n.btn:hover::before {\n    width: 400px;\n    height: 400px;\n}\n\n.btn:hover {\n    transform: translateY(-4px) scale(1.03);\n    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);\n}\n\n.btn:active {\n    transform: translateY(-1px) scale(0.98);\n}\n\n.btn-primary {\n    background: var(--gradient-primary);\n    background-size: 200% 200%;\n    color: var(--hayuelos-blanco);\n    animation: gradientShift 4s ease infinite;\n}\n\n.btn-primary:hover {\n    color: var(--hayuelos-blanco);\n    animation: gradientShift 2s ease infinite;\n}\n\n.btn-success {\n    background: var(--gradient-success);\n    background-size: 200% 200%;\n    color: var(--hayuelos-negro);\n    animation: gradientShift 4s ease infinite;\n}\n\n.btn-success:hover {\n    color: var(--hayuelos-negro);\n    animation: gradientShift 2s ease infinite;\n}\n\n.btn-info {\n    background: var(--gradient-secondary);\n    background-size: 200% 200%;\n    color: var(--hayuelos-negro);\n    animation: gradientShift 4s ease infinite;\n}\n\n.btn-info:hover {\n    color: var(--hayuelos-negro);\n    animation: gradientShift 2s ease infinite;\n}\n\n.btn-secondary {\n    background: var(--gradient-dark);\n    background-size: 200% 200%;\n    color: var(--hayuelos-blanco);\n}\n\n.btn-secondary:hover {\n    color: var(--hayuelos-blanco);\n}\n\n.btn-warning {\n    background: linear-gradient(135deg, #FFA500 0%, #FFB733 50%, #FFA500 100%);\n    background-size: 200% 200%;\n    color: var(--hayuelos-negro);\n    animation: gradientShift 4s ease infinite;\n}\n\n.btn-warning:hover {\n    color: var(--hayuelos-negro);\n    animation: gradientShift 2s ease infinite;\n}\n\n@keyframes gradientShift {\n    0%, 100% { background-position: 0% 50%; }\n    50% { background-position: 100% 50%; }\n}\n\n/* ========================================\n   CARDS CON DEGRADADOS Y EFECTOS 3D\n   ======================================== */\n.card {\n    border-radius: 20px;\n    border: none;\n    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);\n    overflow: hidden;\n    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);\n    background: var(--hayuelos-blanco);\n    position: relative;\n}\n\n.card::before {\n    content: '';\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    height: 5px;\n    background: var(--gradient-hero);\n    background-size: 200% 100%;\n    animation: borderFlow 6s linear infinite;\n}\n\n.card:hover {\n    transform: translateY(-12px) scale(1.02);\n    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);\n}\n\n.card-header {\n    background: var(--gradient-primary) !important;\n    background-size: 200% 200%;\n    animation: gradientShift 6s ease infinite;\n    color: var(--hayuelos-blanco);\n    border-radius: 20px 20px 0 0 !important;\n    font-weight: bold;\n    padding: 1.25rem;\n    border: none;\n    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);\n}\n\n.card-header.bg-primary {\n    background: var(--gradient-secondary) !important;\n    background-size: 200% 200%;\n    animation: gradientShift 6s ease infinite;\n    color: var(--hayuelos-negro);\n    text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.3);\n}\n\n.card-header.bg-info {\n    background: var(--gradient-secondary) !important;\n    background-size: 200% 200%;\n    animation: gradientShift 6s ease infinite;\n    color: var(--hayuelos-negro);\n    text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.3);\n}\n\n.card-header.bg-success {\n    background: var(--gradient-success) !important;\n    background-size: 200% 200%;\n    animation: gradientShift 6s ease infinite;\n    color: var(--hayuelos-negro);\n    text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.3);\n}\n\n.card-header.bg-warning {\n    background: var(--gradient-success) !important;\n    background-size: 200% 200%;\n    animation: gradientShift 6s ease infinite;\n    color: var(--hayuelos-negro);\n    text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.3);\n}\n\n.card-header.bg-dark {\n    background: var(--gradient-dark) !important;\n    background-size: 200% 200%;\n    color: var(--hayuelos-blanco);\n    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);\n}\n\n/* Cards de dashboard con bordes laterales vibrantes */\n.card.border-left-primary {\n    border-left: 8px solid var(--hayuelos-rojo) !important;\n    box-shadow: -5px 0 20px rgba(225, 0, 0, 0.3);\n}\n\n.card.border-left-success {\n    border-left: 8px solid var(--hayuelos-verde) !important;\n    box-shadow: -5px 0 20px rgba(0, 225, 0, 0.3);\n}\n\n.card.border-left-info {\n    border-left: 8px solid var(--hayuelos-azul) !important;\n    box-shadow: -5px 0 20px rgba(0, 225, 225, 0.3);\n}\n\n.card.border-left-warning {\n    border-left: 8px solid var(--hayuelos-verde) !important;\n    box-shadow: -5px 0 20px rgba(0, 225, 0, 0.3);\n}\n\n/* ========================================\n   PROGRESS BARS CON DEGRADADOS ANIMADOS\n   ======================================== */\n.progress {\n    border-radius: 25px;\n    background-color: #e9ecef;\n    border: 2px solid var(--hayuelos-azul);\n    height: 32px;\n    box-shadow: inset 0 3px 8px rgba(0, 0, 0, 0.15);\n    overflow: hidden;\n}\n\n.progress-bar {\n    border-radius: 23px;\n    background: var(--gradient-hero);\n    background-size: 200% 100%;\n    animation: progressFlow 3s linear infinite;\n    box-shadow: 0 3px 15px rgba(0, 225, 225, 0.5);\n    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);\n    position: relative;\n    overflow: hidden;\n    font-weight: 700;\n    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);\n}\n\n.progress-bar::after {\n    content: '';\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background: linear-gradient(90deg, \n        transparent, \n        rgba(255, 255, 255, 0.4), \n        transparent);\n    animation: shimmer 2s infinite;\n}\n\n@keyframes progressFlow {\n    0% { background-position: 0% 50%; }\n    100% { background-position: 200% 50%; }\n}\n\n@keyframes shimmer {\n    0% { transform: translateX(-100%); }\n    100% { transform: translateX(200%); }\n}\n\n.progress-bar.bg-info {\n    background: var(--gradient-secondary) !important;\n    background-size: 200% 100%;\n    animation: progressFlow 3s linear infinite;\n}\n\n.progress-bar.bg-success {\n    background: var(--gradient-success) !important;\n    background-size: 200% 100%;\n    animation: progressFlow 3s linear infinite;\n}\n\n.progress-bar.bg-danger {\n    background: var(--gradient-primary) !important;\n    background-size: 200% 100%;\n    animation: progressFlow 3s linear infinite;\n}\n\n/* ========================================\n   TABLES CON ESTILO MODERNO\n   ======================================== */\n.table {\n    border-radius: 15px;\n    overflow: hidden;\n    box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);\n}\n\n.table thead {\n    background: var(--gradient-dark);\n    background-size: 200% 200%;\n    animation: gradientShift 8s ease infinite;\n    color: var(--hayuelos-blanco);\n}\n\n.table thead th {\n    border: none;\n    font-weight: 700;\n    text-transform: uppercase;\n    font-size: 0.85rem;\n    letter-spacing: 0.5px;\n    padding: 1rem;\n}\n\n.table-dark {\n    background: var(--gradient-dark);\n    color: var(--hayuelos-blanco);\n}\n\n.table-bordered {\n    border: 3px solid var(--hayuelos-azul);\n}\n\n.table-striped tbody tr:nth-of-type(odd) {\n    background: linear-gradient(90deg, \n        rgba(0, 225, 225, 0.05) 0%, \n        rgba(225, 0, 0, 0.05) 100%);\n}\n\n.table tbody tr {\n    transition: all 0.3s ease;\n}\n\n.table tbody tr:hover {\n    background: linear-gradient(90deg, \n        rgba(0, 225, 225, 0.15) 0%, \n        rgba(225, 0, 0, 0.15) 100%) !important;\n    transform: scale(1.01);\n    box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);\n}\n\n.table-hover tbody tr:hover {\n    cursor: pointer;\n}\n\n/* ========================================\n   ALERTS CON DEGRADADOS\n   ======================================== */\n.alert {\n    border-radius: 15px;\n    border: none;\n    border-left: 6px solid;\n    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);\n    font-weight: 500;\n}\n\n.alert-success {\n    background: linear-gradient(135deg, \n        rgba(0, 225, 0, 0.15) 0%, \n        rgba(0, 225, 0, 0.05) 100%);\n    border-left-color: var(--hayuelos-verde);\n    color: #006400;\n}\n\n.alert-danger {\n    background: linear-gradient(135deg, \n        rgba(225, 0, 0, 0.15) 0%, \n        rgba(225, 0, 0, 0.05) 100%);\n    border-left-color: var(--hayuelos-rojo);\n    color: #8B0000;\n}\n\n.alert-info {\n    background: linear-gradient(135deg, \n        rgba(0, 225, 225, 0.15) 0%, \n        rgba(0, 225, 225, 0.05) 100%);\n    border-left-color: var(--hayuelos-azul);\n    color: #006B6B;\n}\n\n.alert-warning {\n    background: linear-gradient(135deg, \n        rgba(255, 165, 0, 0.15) 0%, \n        rgba(255, 165, 0, 0.05) 100%);\n    border-left-color: #FFA500;\n    color: #8B4500;\n}\n\n/* ========================================\n   BADGES CON DEGRADADOS\n   ======================================== */\n.badge {\n    border-radius: 20px;\n    padding: 0.5em 1em;\n    font-weight: 700;\n    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);\n}\n\n.badge.bg-primary {\n    background: var(--gradient-primary) !important;\n    background-size: 200% 200%;\n    animation: gradientShift 4s ease infinite;\n    color: var(--hayuelos-blanco) !important;\n}\n\n.badge.bg-success {\n    background: var(--gradient-success) !important;\n    background-size: 200% 200%;\n    animation: gradientShift 4s ease infinite;\n    color: var(--hayuelos-negro) !important;\n}\n\n.badge.bg-info {\n    background: var(--gradient-secondary) !important;\n    background-size: 200% 200%;\n    animation: gradientShift 4s ease infinite;\n    color: var(--hayuelos-negro) !important;\n}\n\n.badge.bg-secondary {\n    background: var(--gradient-dark) !important;\n    color: var(--hayuelos-blanco) !important;\n}\n\n.badge.bg-danger {\n    background: var(--gradient-primary) !important;\n    background-size: 200% 200%;\n    animation: gradientShift 4s ease infinite;\n    color: var(--hayuelos-blanco) !important;\n}\n\n.badge.bg-warning {\n    background: linear-gradient(135deg, #FFA500 0%, #FFB733 50%, #FFA500 100%) !important;\n    background-size: 200% 200%;\n    animation: gradientShift 4s ease infinite;\n    color: var(--hayuelos-negro) !important;\n}\n\n/* ========================================\n   FORMULARIOS CON ESTILO MODERNO\n   ======================================== */\n.form-control, .form-select {\n    border-radius: 15px;\n    border: 3px solid var(--hayuelos-azul);\n    padding: 14px 22px;\n    transition: all 0.3s ease;\n    background: var(--hayuelos-blanco);\n    font-weight: 500;\n}\n\n.form-control:focus, .form-select:focus {\n    border-color: var(--hayuelos-rojo);\n    box-shadow: 0 0 0 0.3rem rgba(225, 0, 0, 0.2);\n    transform: translateY(-3px);\n    background: #ffffff;\n}\n\n.form-label {\n    font-weight: 700;\n    color: var(--hayuelos-negro);\n    margin-bottom: 0.75rem;\n    font-size: 0.95rem;\n}\n\n/* ========================================\n   FOOTER CON DEGRADADO\n   ======================================== */\nfooter {\n    background: var(--gradient-dark) !important;\n    background-size: 200% 200%;\n    animation: gradientShift 10s ease infinite;\n    color: var(--hayuelos-blanco) !important;\n    padding: 2rem 0;\n    border-top: 5px solid transparent;\n    border-image: var(--gradient-hero);\n    border-image-slice: 1;\n    box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.3);\n}\n\n/* ========================================\n   LOGIN Y REGISTER - DEGRADADO VIBRANTE SOLO ROJO\n   ======================================== */\nbody.auth-page {\n    background: linear-gradient(135deg, \n        #E10000 0%, \n        #FF1a1a 15%,\n        #E10000 30%,\n        #FF0000 45%,\n        #E10000 60%,\n        #D90000 75%,\n        #E10000 90%,\n        #FF2020 100%) !important;\n    background-size: 400% 400%;\n    animation: gradientMegaShift 15s ease infinite;\n    min-height: 100vh;\n    display: block;\n    position: relative;\n    overflow-y: auto;\n    overflow-x: hidden;\n}\n\nbody.auth-page::before {\n    content: '';\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background: \n        radial-gradient(circle at 20% 30%, rgba(255, 50, 50, 0.2) 0%, transparent 50%),\n        radial-gradient(circle at 80% 70%, rgba(200, 0, 0, 0.2) 0%, transparent 50%),\n        radial-gradient(circle at 50% 50%, rgba(255, 20, 20, 0.15) 0%, transparent 60%);\n    animation: pulseBackground 8s ease-in-out infinite;\n}\n\nbody.auth-page::after {\n    content: '';\n    position: absolute;\n    top: -50%;\n    left: -50%;\n    width: 200%;\n    height: 200%;\n    background: linear-gradient(45deg,\n        transparent 40%,\n        rgba(255, 100, 100, 0.08) 50%,\n        transparent 60%);\n    animation: rotateShine 12s linear infinite;\n}\n\n@keyframes gradientMegaShift {\n    0% { background-position: 0% 50%; }\n    25% { background-position: 50% 80%; }\n    50% { background-position: 100% 50%; }\n    75% { background-position: 50% 20%; }\n    100% { background-position: 0% 50%; }\n}\n\n@keyframes pulseBackground {\n    0%, 100% { opacity: 1; transform: scale(1); }\n    50% { opacity: 0.85; transform: scale(1.03); }\n}\n\n@keyframes rotateShine {\n    0% { transform: rotate(0deg); }\n    100% { transform: rotate(360deg); }\n}\n\n.auth-page .card {\n    background: var(--hayuelos-blanco);\n    border: none;\n    box-shadow: 0 25px 70px rgba(0, 0, 0, 0.5);\n    position: relative;\n    z-index: 1;\n    transform-style: preserve-3d;\n    transition: all 0.4s ease;\n}\n\n.auth-page .card:hover {\n    transform: translateY(-10px);\n    box-shadow: 0 35px 90px rgba(0, 0, 0, 0.6);\n}\n\n.auth-page .card::before {\n    content: '';\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    height: 8px;\n    background: linear-gradient(90deg, \n        #E10000 0%, \n        #FF2020 25%, \n        #E10000 50%, \n        #FF2020 75%, \n        #E10000 100%);\n    background-size: 200% 100%;\n    animation: borderFlow 5s linear infinite;\n    border-radius: 20px 20px 0 0;\n}\n\n.auth-page .form-label {\n    color: var(--hayuelos-negro);\n    font-weight: 700;\n}\n\n.auth-page a {\n    color: var(--hayuelos-rojo);\n    font-weight: 700;\n    text-decoration: none;\n    transition: all 0.3s ease;\n    position: relative;\n}\n\n.auth-page a::after {\n    content: '';\n    position: absolute;\n    bottom: -2px;\n    left: 0;\n    width: 0;\n    height: 2px;\n    background: linear-gradient(90deg, #E10000, #FF2020, #E10000);\n    transition: width 0.3s ease;\n}\n\n.auth-page a:hover::after {\n    width: 100%;\n}\n\n.auth-page a:hover {\n    color: #FF3333;\n    text-shadow: 0 0 15px rgba(225, 0, 0, 0.6);\n}\n\n/* ========================================\n   ICONOS Y COLORES DE TEXTO\n   ======================================== */\n.text-primary {\n    color: var(--hayuelos-rojo) !important;\n}\n\n.text-success {\n    color: var(--hayuelos-verde) !important;\n}\n\n.text-info {\n    color: var(--hayuelos-azul) !important;\n}\n\n/* ========================================\n   ESTADOS DE TANQUES CON ANIMACIONES\n   ======================================== */\n.estado-excelente {\n    color: var(--hayuelos-verde) !important;\n    animation: pulseGreen 3s ease-in-out infinite;\n}\n\n.estado-bueno {\n    color: var(--hayuelos-azul) !important;\n}\n\n.estado-bajo {\n    color: #FFA500 !important;\n    animation: pulseWarning 2s ease-in-out infinite;\n}\n\n.estado-critico {\n    color: var(--hayuelos-rojo) !important;\n    animation: pulseDanger 1s ease-in-out infinite;\n}\n\n@keyframes pulseGreen {\n    0%, 100% { opacity: 1; transform: scale(1); }\n    50% { opacity: 0.7; transform: scale(1.05); }\n}\n\n@keyframes pulseWarning {\n    0%, 100% { opacity: 1; transform: scale(1); }\n    50% { opacity: 0.8; transform: scale(1.08); }\n}\n\n@keyframes pulseDanger {\n    0%, 100% { opacity: 1; transform: scale(1); }\n    50% { opacity: 0.6; transform: scale(1.15); }\n}\n\n/* ========================================\n   SOMBRAS CORPORATIVAS\n   ======================================== */\n.shadow-primary {\n    box-shadow: 0 10px 35px rgba(225, 0, 0, 0.4) !important;\n}\n\n.shadow-success {\n    box-shadow: 0 10px 35px rgba(0, 225, 0, 0.4) !important;\n}\n\n.shadow-info {\n    box-shadow: 0 10px 35px rgba(0, 225, 225, 0.4) !important;\n}\n\n/* ========================================\n   EFECTOS HOVER PARA ELEMENTOS INTERACTIVOS\n   ======================================== */\n.clickable {\n    cursor: pointer;\n    transition: all 0.3s ease;\n}\n\n.clickable:hover {\n    transform: scale(1.03);\n}\n\n/* ========================================\n   ANIMACIONES DE ENTRADA\n   ======================================== */\n@keyframes fadeIn {\n    from {\n        opacity: 0;\n        transform: translateY(30px);\n    }\n    to {\n        opacity: 1;\n        transform: translateY(0);\n    }\n}\n\n.fade-in {\n    animation: fadeIn 0.8s ease-out;\n}\n\n/* ========================================\n   ESTILOS ESPEC√É¬çFICOS DEL DASHBOARD\n   ======================================== */\n.text-xs {\n    font-size: 0.75rem;\n    font-weight: 600;\n    letter-spacing: 0.5px;\n}\n\n.font-weight-bold {\n    font-weight: 700 !important;\n}\n\n.text-gray-800 {\n    color: #2d3436 !important;\n}\n\n.text-gray-300 {\n    color: #b2bec3 !important;\n}\n\n/* ========================================\n   PERSONALIZACI√É‚ÄúN POR ROL - CARDS ESTAD√É¬çSTICAS\n   ======================================== */\n\n/* Admin - Cards con acento rojo */\nbody.role-admin .card.border-left-primary {\n    border-left-color: var(--hayuelos-rojo) !important;\n    box-shadow: -8px 0 25px rgba(225, 0, 0, 0.3);\n}\n\nbody.role-admin .text-primary {\n    color: var(--hayuelos-rojo) !important;\n}\n\n/* Encargado - Cards con acento azul */\nbody.role-encargado .card.border-left-primary {\n    border-left-color: var(--hayuelos-azul) !important;\n    box-shadow: -8px 0 25px rgba(0, 225, 225, 0.3);\n}\n\nbody.role-encargado .text-primary {\n    color: var(--hayuelos-azul) !important;\n}\n\nbody.role-encargado .card-header {\n    background: var(--gradient-secondary) !important;\n    color: var(--hayuelos-negro) !important;\n}\n\n/* Islero - Cards con acento verde */\nbody.role-islero .card.border-left-primary {\n    border-left-color: var(--hayuelos-verde) !important;\n    box-shadow: -8px 0 25px rgba(0, 225, 0, 0.3);\n}\n\nbody.role-islero .text-primary {\n    color: var(--hayuelos-verde) !important;\n}\n\nbody.role-islero .card-header {\n    background: var(--gradient-success) !important;\n    color: var(--hayuelos-negro) !important;\n}\n\n/* ========================================\n   RESPONSIVE DESIGN\n   ======================================== */\n@media (max-width: 768px) {\n    .btn {\n        padding: 10px 20px;\n        font-size: 0.9rem;\n    }\n    \n    .card {\n        margin-bottom: 1.5rem;\n    }\n    \n    .navbar-brand {\n        font-size: 1.2rem;\n    }\n    \n    .table {\n        font-size: 0.85rem;\n    }\n    \n    h1, .h3 {\n        font-size: 1.5rem;\n    }\n}\n\n@media (max-width: 576px) {\n    .card.border-left-primary,\n    .card.border-left-success,\n    .card.border-left-info,\n    .card.border-left-warning {\n        border-left-width: 5px;\n    }\n    \n    .progress {\n        height: 25px;\n    }\n}\n\n/* ========================================\n   UTILIDADES ADICIONALES\n   ======================================== */\n.no-gutters {\n    margin-right: 0;\n    margin-left: 0;\n}\n\n.no-gutters > .col,\n.no-gutters > [class*=\"col-\"] {\n    padding-right: 0;\n    padding-left: 0;\n}\n\n/* Mejoras visuales para iconos */\n.bi {\n    vertical-align: middle;\n}\n\n.bi.fa-2x {\n    font-size: 2rem;\n}\n\n/* Espaciado consistente */\n.py-2 {\n    padding-top: 0.5rem !important;\n    padding-bottom: 0.5rem !important;\n}\n\n.py-3 {\n    padding-top: 1rem !important;\n    padding-bottom: 1rem !important;\n}\n\n.mb-1 {\n    margin-bottom: 0.25rem !important;\n}\n\n.mb-3 {\n    margin-bottom: 1rem !important;\n}\n\n.mb-4 {\n    margin-bottom: 1.5rem !important;\n}\n\n.mt-3 {\n    margin-top: 1rem !important;\n}\n\n.mt-4 {\n    margin-top: 1.5rem !important;\n}\n\n.mt-5 {\n    margin-top: 3rem !important;\n}\n\n/* ========================================\n   FIN DEL ARCHIVO\n   ======================================== */","path":null,"size_bytes":28454,"size_tokens":null},"app_factory.py":{"content":"# # app_factory.py - ACTUALIZADO CON MEJORAS DE SEGURIDAD\n# import os\n# from flask import Flask\n# from extensions import db, login_manager, migrate, csrf, mail\n# from dotenv import load_dotenv\n\n# load_dotenv()  # Cargar variables de entorno\n\n# def create_app():\n#     from dotenv import load_dotenv\n#     load_dotenv()  # üëà AGREGAR ESTA L√çNEA\n    \n#     app = Flask(__name__)\n    \n#     # Configuraci√≥n\n#     app.config['SECRET_KEY'] = os.environ.get('SESSION_SECRET', 'fallback-secret-key-change-in-production')\n    \n#     # Base de datos - PostgreSQL de Replit\n#     database_url = os.environ.get('DATABASE_URL')\n#     if database_url:\n#         app.config['SQLALCHEMY_DATABASE_URI'] = database_url\n#     else:\n#         # Fallback a MySQL local para desarrollo\n#         app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql+pymysql://root:@localhost/sitex_prueba'\n    \n#     app.config['SQLALCHEMY_ENGINE_OPTIONS'] = {\n#         'pool_recycle': 300,\n#         'pool_pre_ping': True,\n#     }\n#     app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False\n    \n#     # Configuraci√≥n de correo para recuperaci√≥n de contrase√±a\n#     app.config['MAIL_SERVER'] = os.environ.get('MAIL_SERVER', 'smtp.gmail.com')\n#     app.config['MAIL_PORT'] = int(os.environ.get('MAIL_PORT', 587))\n#     app.config['MAIL_USE_TLS'] = True\n#     app.config['MAIL_USERNAME'] = os.environ.get('MAIL_USERNAME')\n#     app.config['MAIL_PASSWORD'] = os.environ.get('MAIL_PASSWORD')\n#     app.config['MAIL_DEFAULT_SENDER'] = os.environ.get('MAIL_DEFAULT_SENDER', 'noreply@hayuelos.com')\n    \n#     # Configuraci√≥n de uploads\n#     app.config['UPLOAD_FOLDER'] = 'static/uploads'\n#     app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024  # 16MB max\n#     app.config['ALLOWED_EXTENSIONS'] = {'png', 'jpg', 'jpeg', 'gif', 'pdf'}\n    \n#     # Inicializar extensiones\n#     db.init_app(app)\n#     login_manager.init_app(app)\n#     migrate.init_app(app, db)\n#     csrf.init_app(app)\n#     mail.init_app(app)\n    \n#     # Configuraci√≥n de login_manager\n#     login_manager.login_view = 'auth.login'\n#     login_manager.login_message = 'Por favor inicie sesi√≥n para acceder a esta p√°gina.'\n#     login_manager.login_message_category = 'warning'\n    \n#     # Cargador de usuario\n#     @login_manager.user_loader\n#     def load_user(user_id):\n#         from models import Empleado\n#         empleado = db.session.get(Empleado, int(user_id))\n#         # Verificar si el usuario est√° activo\n#         if empleado and not empleado.activo:\n#             return None\n#         return empleado\n    \n#     # Registrar blueprints\n#     from routes import auth_bp, main_bp, dashboard_bp, medicion_bp, admin_bp\n#     app.register_blueprint(auth_bp)\n#     app.register_blueprint(main_bp)\n#     app.register_blueprint(dashboard_bp)\n#     app.register_blueprint(medicion_bp)\n#     app.register_blueprint(admin_bp)\n    \n#     # Crear tablas y datos iniciales\n#     with app.app_context():\n#         db.create_all()\n        \n#         from models import Empleado, Tanque\n#         # Verificar si ya hay tanques\n#         if db.session.query(Tanque).count() == 0:\n#             tanque1 = Tanque(tipo_combustible='Diesel', capacidad=6000, activo=True)\n#             tanque2 = Tanque(tipo_combustible='Diesel', capacidad=12000, activo=True)\n#             tanque3 = Tanque(tipo_combustible='ACPM', capacidad=12000, activo=True)\n#             tanque4 = Tanque(tipo_combustible='Extra', capacidad=6000, activo=True)\n\n#             db.session.add_all([tanque1, tanque2, tanque3, tanque4])\n#             db.session.commit()\n#             print(\"‚úì Tanques creados\")\n    \n#     # Protecci√≥n contra XSS en templates\n#     @app.after_request\n#     def set_secure_headers(response):\n#         response.headers['X-Content-Type-Options'] = 'nosniff'\n#         response.headers['X-Frame-Options'] = 'SAMEORIGIN'\n#         response.headers['X-XSS-Protection'] = '1; mode=block'\n#         return response\n    \n#     return app\n\n\n# app_factory.py - OPTIMIZADO PARA VERCEL\nimport os\nfrom flask import Flask\nfrom extensions import db, login_manager, migrate, csrf, mail\nfrom dotenv import load_dotenv\n\nload_dotenv()\n\ndef create_app():\n    app = Flask(__name__)\n    \n    # Configuraci√≥n general\n    app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY', 'fallback-secret-key-change-in-production')\n\n    # Configuraci√≥n base de datos - CORREGIDA PARA VERCEL\n    database_url = os.environ.get('DATABASE_URL')\n    \n    if not database_url:\n        # Fallback para desarrollo local\n        database_url = 'mysql+pymysql://root:@localhost/sitex_prueba'\n    elif database_url.startswith(\"postgres://\"):\n        # Convert postgres:// to postgresql:// for SQLAlchemy compatibility\n        database_url = database_url.replace(\"postgres://\", \"postgresql://\", 1)\n    elif database_url.startswith(\"mysql://\"):\n        # Convertir mysql:// a mysql+pymysql:// si es necesario\n        database_url = database_url.replace(\"mysql://\", \"mysql+pymysql://\", 1)\n    \n    app.config['SQLALCHEMY_DATABASE_URI'] = database_url\n    app.config['SQLALCHEMY_ENGINE_OPTIONS'] = {\n        'pool_recycle': 300,\n        'pool_pre_ping': True,\n        'pool_size': 10,\n        'max_overflow': 20\n    }\n    app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False\n\n    # Configuraci√≥n de correo\n    app.config['MAIL_SERVER'] = os.environ.get('MAIL_SERVER', 'smtp.gmail.com')\n    app.config['MAIL_PORT'] = int(os.environ.get('MAIL_PORT', 587))\n    app.config['MAIL_USE_TLS'] = os.environ.get('MAIL_USE_TLS', 'True') == 'True'\n    app.config['MAIL_USERNAME'] = os.environ.get('MAIL_USERNAME')\n    app.config['MAIL_PASSWORD'] = os.environ.get('MAIL_PASSWORD')\n    app.config['MAIL_DEFAULT_SENDER'] = os.environ.get('MAIL_DEFAULT_SENDER', 'noreply@sitex.com')\n    \n    # Configuraci√≥n uploads\n    app.config['UPLOAD_FOLDER'] = 'static/uploads'\n    app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024\n    app.config['ALLOWED_EXTENSIONS'] = {'png', 'jpg', 'jpeg', 'gif', 'pdf'}\n    \n    # Inicializar extensiones\n    db.init_app(app)\n    login_manager.init_app(app)\n    migrate.init_app(app, db)\n    csrf.init_app(app)\n    mail.init_app(app)\n    \n    # Config login\n    login_manager.login_view = 'auth.login'\n    login_manager.login_message = 'Por favor inicie sesi√≥n para acceder a esta p√°gina.'\n    login_manager.login_message_category = 'warning'\n    \n    # Cargador de usuario\n    @login_manager.user_loader\n    def load_user(user_id):\n        from models import Empleado\n        empleado = db.session.get(Empleado, int(user_id))\n        if empleado and not empleado.activo:\n            return None\n        return empleado\n    \n    # Blueprints\n    from routes import auth_bp, main_bp, dashboard_bp, medicion_bp, admin_bp\n    app.register_blueprint(auth_bp)\n    app.register_blueprint(main_bp)\n    app.register_blueprint(dashboard_bp)\n    app.register_blueprint(medicion_bp)\n    app.register_blueprint(admin_bp)\n    \n    # Crear tablas solo en desarrollo - NO en Vercel\n    with app.app_context():\n        try:\n            db.create_all()\n            \n            from models import Tanque\n            if db.session.query(Tanque).count() == 0:\n                tanques = [\n                    Tanque(tipo_combustible='Diesel', capacidad=6000, activo=True),\n                    Tanque(tipo_combustible='Diesel', capacidad=12000, activo=True),\n                    Tanque(tipo_combustible='ACPM', capacidad=12000, activo=True),\n                    Tanque(tipo_combustible='Extra', capacidad=6000, activo=True)\n                ]\n                db.session.add_all(tanques)\n                db.session.commit()\n                print(\"‚úì Tanques creados\")\n        except Exception as e:\n            print(f\"Error al crear tablas: {e}\")\n\n    @app.after_request\n    def set_secure_headers(response):\n        response.headers['X-Content-Type-Options'] = 'nosniff'\n        response.headers['X-Frame-Options'] = 'SAMEORIGIN'\n        response.headers['X-XSS-Protection'] = '1; mode=block'\n        return response\n\n    return app\n","path":null,"size_bytes":8014,"size_tokens":null}},"version":2}