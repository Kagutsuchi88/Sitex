{% extends "base.html" %}

{% block title %}Estadísticas - Hayuelos{% endblock %}

{% block extra_css %}
<style>
.stat-card {
    border-radius: 20px;
    overflow: hidden;
    transition: all 0.3s ease;
    border: none;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
}

.alert-tanque {
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
}

.alert-tanque:hover {
    transform: scale(1.02);
}

.alert-critico {
    background: linear-gradient(135deg, #FFE5E5 0%, #FFC5C5 100%);
    border-left: 5px solid #E10000;
}

.alert-bajo {
    background: linear-gradient(135deg, #FFF3CD 0%, #FFE69C 100%);
    border-left: 5px solid #FFC107;
}

.porcentaje-bar {
    height: 12px;
    background: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
    margin-top: 10px;
}

.porcentaje-fill {
    height: 100%;
    border-radius: 10px;
    transition: width 0.8s ease;
}

.porcentaje-critico {
    background: linear-gradient(90deg, #E10000, #FF4040);
}

.porcentaje-bajo {
    background: linear-gradient(90deg, #FFC107, #FFD54F);
}

.metric-box {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 20px;
    padding: 25px;
    text-align: center;
    transition: all 0.3s ease;
}

.metric-box:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.metric-value {
    font-size: 2.5rem;
    font-weight: 700;
}

.metric-cargado {
    color: #00C853;
}

.metric-vendido {
    color: #E10000;
}

.metric-diferencia {
    color: #2196F3;
}

.eficiencia-gauge {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    background: conic-gradient(
        #00C853 0deg,
        #00C853 calc(var(--porcentaje) * 3.6deg),
        #e9ecef calc(var(--porcentaje) * 3.6deg)
    );
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
}

.eficiencia-inner {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
}

.eficiencia-valor {
    font-size: 2rem;
    font-weight: 700;
    color: #00C853;
}

.chart-container {
    position: relative;
    height: 300px;
    margin: 20px 0;
}

.btn-reporte {
    background: linear-gradient(135deg, #E10000 0%, #FF3030 100%);
    border: none;
    border-radius: 15px;
    padding: 15px 30px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-reporte:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(225, 0, 0, 0.4);
}

.sin-alertas {
    background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
    border-radius: 20px;
    padding: 40px;
    text-align: center;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="bi bi-graph-up-arrow"></i> Panel de Decisiones
        </h1>
        <div>
            <a href="{{ url_for('dashboard.reporte_mensual') }}" class="btn btn-reporte text-white me-2">
                <i class="bi bi-file-earmark-pdf"></i> Descargar Reporte Mensual
            </a>
            <a href="{{ url_for('dashboard.index') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card stat-card h-100">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-exclamation-triangle-fill"></i> Alerta de Stock Bajo
                    </h4>
                    <small>Tanques que necesitan recarga urgente</small>
                </div>
                <div class="card-body">
                    {% if tanques_alerta %}
                        {% for tanque in tanques_alerta %}
                        <div class="alert-tanque alert-{{ tanque.nivel }}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="mb-1">
                                        <i class="bi bi-fuel-pump-fill"></i> {{ tanque.tipo }}
                                        <span class="badge {% if tanque.nivel == 'critico' %}bg-danger{% else %}bg-warning text-dark{% endif %}">
                                            {% if tanque.nivel == 'critico' %}CRÍTICO{% else %}BAJO{% endif %}
                                        </span>
                                    </h5>
                                    <p class="mb-0 text-muted">Tanque #{{ tanque.id }}</p>
                                </div>
                                <div class="text-end">
                                    <h4 class="mb-0 {% if tanque.nivel == 'critico' %}text-danger{% else %}text-warning{% endif %}">
                                        {{ tanque.porcentaje }}%
                                    </h4>
                                    <small class="text-muted">{{ tanque.contenido | int }} / {{ tanque.capacidad | int }} gal</small>
                                </div>
                            </div>
                            <div class="porcentaje-bar">
                                <div class="porcentaje-fill porcentaje-{{ tanque.nivel }}" style="width: {{ tanque.porcentaje }}%;"></div>
                            </div>
                            <div class="mt-2 text-end">
                                <small class="{% if tanque.nivel == 'critico' %}text-danger{% else %}text-warning{% endif %}">
                                    <i class="bi bi-arrow-up-circle"></i> Necesita {{ tanque.galones_faltantes | int }} galones
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="sin-alertas">
                            <i class="bi bi-check-circle-fill text-success display-1"></i>
                            <h4 class="mt-3 text-success">Todos los tanques OK</h4>
                            <p class="text-muted mb-0">No hay tanques con niveles bajos de combustible</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card stat-card h-100">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-speedometer2"></i> Rendimiento del Mes
                    </h4>
                    <small>Balance entre cargado y vendido</small>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-4">
                            <div class="metric-box">
                                <i class="bi bi-arrow-down-circle-fill text-success fs-2 mb-2"></i>
                                <div class="metric-value metric-cargado">{{ rendimiento.total_cargado | int }}</div>
                                <small class="text-muted">Galones Cargados</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="metric-box">
                                <i class="bi bi-arrow-up-circle-fill text-danger fs-2 mb-2"></i>
                                <div class="metric-value metric-vendido">{{ rendimiento.total_vendido | int }}</div>
                                <small class="text-muted">Galones Vendidos</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="metric-box">
                                <i class="bi bi-plus-slash-minus fs-2 mb-2 text-primary"></i>
                                <div class="metric-value metric-diferencia">{{ rendimiento.diferencia | int }}</div>
                                <small class="text-muted">Diferencia</small>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mb-4">
                        <div class="eficiencia-gauge" style="--porcentaje: {{ rendimiento.porcentaje_eficiencia }};">
                            <div class="eficiencia-inner">
                                <span class="eficiencia-valor">{{ rendimiento.porcentaje_eficiencia }}%</span>
                                <small class="text-muted">Eficiencia</small>
                            </div>
                        </div>
                        <p class="mt-3 mb-0">
                            {% if rendimiento.estado == 'alerta' %}
                                <span class="badge bg-danger fs-6">
                                    <i class="bi bi-exclamation-triangle"></i> Posible fuga o pérdida detectada
                                </span>
                            {% else %}
                                <span class="badge bg-success fs-6">
                                    <i class="bi bi-check-circle"></i> Operación Normal
                                </span>
                            {% endif %}
                        </p>
                    </div>

                    {% if ventas_por_tipo %}
                    <h6 class="mb-3"><i class="bi bi-pie-chart-fill"></i> Ventas por Tipo de Combustible</h6>
                    <div class="chart-container">
                        <canvas id="chartVentas"></canvas>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if ventas_por_dia %}
    <div class="row">
        <div class="col-12">
            <div class="card stat-card">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-calendar-week"></i> Días con Más Ventas (Últimos 30 días)
                    </h4>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="chartDias"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if ventas_por_tipo %}
    const ctxVentas = document.getElementById('chartVentas');
    if (ctxVentas) {
        new Chart(ctxVentas, {
            type: 'doughnut',
            data: {
                labels: {{ ventas_por_tipo.keys()|list|tojson }},
                datasets: [{
                    data: {{ ventas_por_tipo.values()|list|tojson }},
                    backgroundColor: [
                        'rgba(225, 0, 0, 0.8)',
                        'rgba(0, 225, 225, 0.8)',
                        'rgba(0, 225, 0, 0.8)',
                        'rgba(255, 165, 0, 0.8)',
                        'rgba(138, 43, 226, 0.8)'
                    ],
                    borderWidth: 3,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { font: { size: 14 } }
                    }
                }
            }
        });
    }
    {% endif %}

    {% if ventas_por_dia %}
    const ctxDias = document.getElementById('chartDias');
    if (ctxDias) {
        const fechas = {{ ventas_por_dia.keys()|list|tojson }};
        const valores = {{ ventas_por_dia.values()|list|tojson }};
        const fechasCortas = fechas.map(f => f.slice(-5));
        
        new Chart(ctxDias, {
            type: 'bar',
            data: {
                labels: fechasCortas,
                datasets: [{
                    label: 'Galones Vendidos',
                    data: valores,
                    backgroundColor: 'rgba(225, 0, 0, 0.7)',
                    borderColor: 'rgba(225, 0, 0, 1)',
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Galones' }
                    },
                    x: {
                        title: { display: true, text: 'Fecha' }
                    }
                }
            }
        });
    }
    {% endif %}
});
</script>
{% endblock %}